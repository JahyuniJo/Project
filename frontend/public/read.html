<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ƒê·ªçc truy·ªán | DH.story</title>
  <link rel="icon" type="image/png" href="/components/Logo.png" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.8s ease-in forwards; }

    .cover {
      transition: transform 0.4s ease, box-shadow 0.4s ease;
    }
    .cover:hover {
      transform: scale(1.03);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .title-hover:hover {
      color: #4f46e5;
      text-shadow: 0 0 10px rgba(79, 70, 229, 0.2);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-100 min-h-screen flex flex-col font-sans text-gray-800">

  <!-- HEADER -->
    <header class="bg-white shadow-md">
    <div class="container mx-auto flex flex-col md:flex-row items-center justify-between py-4 px-6">
      
      <!-- Logo -->
      <div class="flex items-center gap-3">
        <a href="index.html" class="flex items-center gap-2">
          <img src="/components/Logo.png" alt="Logo" class="w-10 h-10 rounded-full">
          <span class="text-2xl font-bold text-indigo-600">DH.story</span>
        </a>
      </div>

      <!-- Slogan -->
      <p class="italic text-gray-500 text-sm md:text-base mt-2 md:mt-0">
        Ch√∫c c√°c b·∫°n ƒë·ªçc truy·ªán vui v·∫ª!
      </p>

      <!-- Search + Menu -->
      <div class="flex flex-col md:flex-row items-center gap-4 mt-4 md:mt-0">
        <!-- Search -->
          <div class="relative">
          <div class="flex items-center bg-gray-100 rounded-full overflow-hidden shadow-inner">
          <input id="searchBox" type="text" placeholder="T√¨m ki·∫øm truy·ªán..."
                  class="px-4 py-2 bg-transparent focus:outline-none w-48 md:w-64 text-gray-700">
          <button id="searchBtn" class="px-3 text-indigo-600 hover:text-indigo-800" aria-label="T√¨m ki·∫øm">
            <i class="fa-solid fa-magnifying-glass"></i>
          </button>
          </div>

          <!-- Popover k·∫øt qu·∫£ -->
          <div id="searchSuggestions" 
              class="absolute left-0 right-0 bg-white shadow-lg rounded-lg mt-1 hidden max-h-64 overflow-y-auto z-50 border border-gray-200">
          </div>
          </div>

        

        <!-- Menu -->
        <nav>
          <ul class="flex flex-wrap justify-center md:justify-start gap-4 text-sm font-medium text-gray-700">
            <li><a href="Truy·ªán h√†i.html" class="hover:text-indigo-600">Truy·ªán h√†i</a></li>
            <li><a href="Truy·ªán ng√¥n t√¨nh.html" class="hover:text-indigo-600">Truy·ªán ng√¥n t√¨nh</a></li>
            <li><a href="Truy·ªán kinh d·ªã.html" class="hover:text-indigo-600">Truy·ªán kinh d·ªã</a></li>
            <li><a href="Truy·ªán trinh th√°m.html" class="hover:text-indigo-600">Truy·ªán trinh th√°m</a></li>
          </ul>
        </nav>
      </div>

      <!-- Buttons -->
      <div class="flex gap-3 mt-4 md:mt-0">
        <a href="login.html" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
          ƒêƒÉng nh·∫≠p
        </a>
        <a href="register.html" class="px-4 py-2 bg-white text-indigo-600 border border-indigo-600 rounded-lg hover:bg-indigo-50 transition">
          ƒêƒÉng k√Ω
        </a>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="flex-1 container mx-auto py-10 px-6 fade-in">
    <div id="story-container" class="bg-white shadow-lg rounded-2xl p-8 flex flex-col md:flex-row gap-8">

      <!-- ·∫¢nh b√¨a -->
      <div class="flex-shrink-0 self-center">
        <img id="story-cover" src="" alt="B√¨a truy·ªán" class="w-56 h-80 object-cover rounded-xl cover" />
      </div>

      <!-- N·ªôi dung truy·ªán -->
      <div class="flex-1">
        <h1 id="story-title" class="text-3xl font-bold text-indigo-700 mb-2 title-hover"></h1>
        <p id="story-author" class="text-gray-600 mb-4 italic"></p>
        <p id="story-genres" class="text-sm text-gray-500 mb-6"></p>
        <a id="story-link" href="#" target="_blank"
           class="inline-block bg-indigo-600 text-white font-semibold px-5 py-2 rounded-xl shadow-md hover:bg-indigo-700 transition duration-300 mb-6">
           üìñ ƒê·ªçc truy·ªán g·ªëc
        </a>
        <div id="story-content" class="leading-relaxed text-gray-800 text-justify whitespace-pre-line"></div>
      </div>
    </div>
     <!-- COMMENT SECTION -->
<div class="mt-10 bg-white shadow-lg p-6 rounded-xl">

  <h2 class="text-xl font-bold text-gray-800 mb-4">üí¨ B√¨nh lu·∫≠n</h2>

  <!-- Form comment -->
  <textarea id="commentInput" 
            placeholder="Vi·∫øt b√¨nh lu·∫≠n..." 
            class="w-full border rounded-lg p-3 focus:ring focus:ring-indigo-300 outline-none mb-6"></textarea>

  <a href="login.html"
          class=" px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
    ƒêƒÉng nh·∫≠p ƒë·ªÉ tham gia b√¨nh lu·∫≠n
</a>

  <!-- Comment list -->
  <div id="commentList" class="mt-6 space-y-4"></div>
</div>
  </main>


  

  <!-- FOOTER -->
  <footer class="bg-white mt-10 shadow-inner">
    <div class="container mx-auto py-6 px-6 flex flex-col md:flex-row justify-between items-center">
      <div class="flex items-center gap-2 mb-4 md:mb-0">
        <img src="/components/Logo.png" alt="Logo" class="w-8 h-8 rounded-full">
        <span class="font-bold text-indigo-600 text-lg">DH.story</span>
      </div>
      <div class="text-center md:text-right text-gray-600 text-sm">
        <p class="font-semibold text-gray-800 mb-1">LI√äN H·ªÜ V·ªöI T√îI</p>
        <a href="https://github.com/JahyuniJo" target="_blank"
           class="flex items-center justify-center md:justify-end gap-2 hover:text-indigo-600">
          <span>Github</span>
          <img src="/components/Github.jpg" alt="Github" class="w-5 h-5 rounded-full">
        </a>
        <p>Email: <a href="mailto:dieu300504@gmail.com" class="hover:text-indigo-600">dieu300504@gmail.com</a></p>
        <p class="mt-2 text-xs text-gray-400">Copyright ¬© 2025 DieuHoang</p>
      </div>
    </div>
  </footer>
  <script src="/components/alertModal.js"></script>
  <script>
    // H√†m l·∫•y ID truy·ªán t·ª´ URL (?id=)
    function getStoryId() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }

    // G·ªçi API l·∫•y chi ti·∫øt truy·ªán
    async function loadStory() {
      const id = getStoryId();
      if (!id) return;

      try {
        const res = await fetch(`/api/stories/${id}`);
        const story = await res.json();

        document.getElementById("story-cover").src = story.cover_url;
        document.getElementById("story-title").textContent = story.title;
        document.getElementById("story-author").textContent = "T√°c gi·∫£: " + story.author;
        document.getElementById("story-genres").textContent = "Th·ªÉ lo·∫°i: " + story.genres;
        document.getElementById("story-content").textContent = story.description;
        const link = document.getElementById("story-link");
        link.href = story.url;
        if (!story.url) link.classList.add("hidden");
      } catch (err) {
        console.error("L·ªói t·∫£i truy·ªán:", err);
      }
    }

    loadStory();
    

    // Search logic
const searchBox = document.getElementById("searchBox");
const searchBtn = document.getElementById("searchBtn");
const suggestionBox = document.getElementById("searchSuggestions");
let typingTimer;

//  H√†m debounce tr√°nh spam API
function debounce(func, delay) {
  clearTimeout(typingTimer);
  typingTimer = setTimeout(func, delay);
}

//  G·ªçi API g·ª£i √Ω Elasticsearch
async function fetchSuggestions(q) {
  if (!q.trim()) {
    suggestionBox.classList.add("hidden");
    return;
  }

  try {
    const res = await fetch(`/api/stories/search?q=${encodeURIComponent(q)}`);
    const data = await res.json();

    if (!data.length) {
      suggestionBox.innerHTML = `<p class="p-3 text-gray-500 text-sm">Kh√¥ng t√¨m th·∫•y...</p>`;
      suggestionBox.classList.remove("hidden");
      return;
    }

    // T·∫°o danh s√°ch g·ª£i √Ω
    suggestionBox.innerHTML = data.map(item => `
      <div onclick="openStory(${item.id})"
           class="flex items-center p-2 hover:bg-indigo-50 cursor-pointer">
        <img src="${item.cover_url || '/default-cover.jpg'}" class="w-10 h-14 object-cover rounded mr-3">
        <div>
          <p class="font-medium text-indigo-700">${item.title}</p>
          <p class="text-xs text-gray-500">${item.author || "Kh√¥ng r√µ t√°c gi·∫£"}</p>
        </div>
      </div>
    `).join("");

    suggestionBox.classList.remove("hidden");

  } catch (err) {
    console.error("‚ùå L·ªói fetchSuggest:", err);
  }
}
//  M·ªü truy·ªán khi ch·ªçn g·ª£i √Ω
window.openStory = function (id) {
  window.location.href = `/read.html?id=${id}`;
};

//  Ch·ªçn g·ª£i √Ω ‚Üí search ngay
window.selectSuggestion = function (title) {
  searchBox.value = title;
  suggestionBox.classList.add("hidden");
  loadStories(1, title);
};

// ‚å® Khi ng∆∞·ªùi d√πng g√µ ‚Üí g·ªçi API g·ª£i √Ω
searchBox.addEventListener("input", () => {
  debounce(() => fetchSuggestions(searchBox.value), 200);
});

// ‚èé Enter ‚Üí t√¨m ki·∫øm
searchBox.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    suggestionBox.classList.add("hidden");
    loadStories(1, searchBox.value.trim());
  }
});

// üîç Click n√∫t t√¨m ki·∫øm
searchBtn.addEventListener("click", () => {
  suggestionBox.classList.add("hidden");
  loadStories(1, searchBox.value.trim());
});

// ·∫®n popover khi click ra ngo√†i
document.addEventListener("click", (e) => {
  if (!searchBox.contains(e.target) && !suggestionBox.contains(e.target)) {
    suggestionBox.classList.add("hidden");
  }
});
// Render comment HTML
function getStoryId() {
  const params = new URLSearchParams(window.location.search);
  return params.get("id");
}
async function loadComments() {
  const id = getStoryId();
  const res = await fetch(`/api/comments?story_id=${id}`);
  const data = await res.json();

  document.getElementById("commentList").innerHTML =
    data.map(c => renderComment(c)).join("");
}
loadComments();
function renderComment(c, level = 0) {
  return `
    <div class="mt-3 ${level > 0 ? "pl-6 border-l" : ""}">
      <p class="font-semibold text-indigo-600">${c.username}</p>
      <p class="text-gray-800">${c.content}</p>

      <div class="flex gap-4 text-sm mt-2">
        <button onclick="likeComment(${c.id})"
                class="text-yellow-600 hover:underline">
          üëç Th√≠ch (${c.likes})
        </button>

      </div>

      <!-- Reply box -->
      <div id="replyBox-${c.id}" class="mt-2 hidden">
        <textarea id="replyInput-${c.id}"
                  class="w-full border rounded-lg p-2 text-sm"
                  placeholder="Vi·∫øt ph·∫£n h·ªìi..."></textarea>

        <button onclick="sendReply(${c.id})"
                class="mt-2 px-3 py-1 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">
          G·ª≠i ph·∫£n h·ªìi
        </button>
      </div>

      ${c.replies.map(r => renderComment(r, level + 1)).join("")}
    </div>
  `;
}

async function likeComment(commentId) {
  try {
    const res = await fetch("/api/comments/like", {
      method: "POST",
      credentials: "include",   // B·∫ÆT BU·ªòC: g·ª≠i cookie authToken
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ comment_id: commentId })
    });

    const data = await res.json();

    if (res.ok) {
      loadComments();           // Reload comment sau khi like th√†nh c√¥ng
    } else {
      showAlert("warning", data.message || "B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th√≠ch b√¨nh lu·∫≠n!", "Ch∆∞a ƒëƒÉng nh·∫≠p");// Hi·ªÉn th·ªã l·ªói t·ª´ backend
    }
  } catch (err) {
    console.error("L·ªói k·∫øt n·ªëi:", err);
    alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi server.");
  }
}



// ======================= SHOW / HIDE REPLY BOX ====================
function toggleReplyBox(commentId, parentUsername = "") {
  const box = document.getElementById(`replyBox-${commentId}`);
  box.classList.toggle("hidden");

  const textarea = document.getElementById(`replyInput-${commentId}`);
  if (!textarea.value && parentUsername) {
    textarea.value = `@${parentUsername} `; // Hi·ªÉn th·ªã s·∫µn t√™n ng∆∞·ªùi comment cha
  }
}
  </script>
</body>
</html>
