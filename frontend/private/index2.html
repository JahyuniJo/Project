<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DH.story - Th·∫ø gi·ªõi truy·ªán</title>
  <link rel="icon" type="image/png" href="/Logo.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>


  <style>
    .description.collapsed {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    @keyframes ring {
      0% {
        transform: rotate(0);
      }

      20% {
        transform: rotate(-15deg);
      }

      40% {
        transform: rotate(15deg);
      }

      60% {
        transform: rotate(-10deg);
      }

      80% {
        transform: rotate(10deg);
      }

      100% {
        transform: rotate(0);
      }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex flex-col font-sans">
  <!-- Header -->
  <header class="bg-white shadow-md">
    <div class="container mx-auto flex flex-col md:flex-row items-center justify-between py-4 px-6">

      <!-- Logo -->
      <div class="flex items-center gap-3">
        <a href="index2.html" class="flex items-center gap-2">
          <img src="/components/Logo.png" alt="Logo" class="w-10 h-10 rounded-full">
          <span class="text-2xl font-bold text-indigo-600">DH.story</span>
        </a>
      </div>

      <!-- Slogan -->
      <p class="italic text-gray-500 text-sm md:text-base mt-2 md:mt-0">
        Ch√∫c c√°c b·∫°n ƒë·ªçc truy·ªán vui v·∫ª!
      </p>

      <!-- Thanh c√¥ng c·ª• -->
      <div class="flex flex-col md:flex-row items-center gap-4 mt-4 md:mt-0">

        <!-- Search -->
        <div class="relative">
          <div class="flex items-center bg-gray-100 rounded-full overflow-hidden shadow-inner">
            <input id="searchBox" type="text" placeholder="T√¨m ki·∫øm truy·ªán..."
              class="px-4 py-2 bg-transparent focus:outline-none w-48 md:w-64 text-gray-700">
            <button id="searchBtn" class="px-3 text-indigo-600 hover:text-indigo-800" aria-label="T√¨m ki·∫øm">
              <i class="fa-solid fa-magnifying-glass"></i>
            </button>
          </div>

          <!-- Popover k·∫øt qu·∫£ -->
          <div id="searchSuggestions"
            class="absolute left-0 right-0 bg-white shadow-lg rounded-lg mt-1 hidden max-h-64 overflow-y-auto z-50 border border-gray-200">
          </div>
        </div>


        <!-- Menu -->
        <nav>
          <ul class="flex flex-wrap justify-center md:justify-start gap-4 text-sm font-medium text-gray-700">
            <li><a href="Truy·ªán h√†i.html" class="hover:text-indigo-600">Truy·ªán h√†i</a></li>
            <li><a href="Truy·ªán ng√¥n t√¨nh.html" class="hover:text-indigo-600">Truy·ªán ng√¥n t√¨nh</a></li>
            <li><a href="Truy·ªán kinh d·ªã.html" class="hover:text-indigo-600">Truy·ªán kinh d·ªã</a></li>
            <li><a href="Truy·ªán trinh th√°m.html" class="hover:text-indigo-600">Truy·ªán trinh th√°m</a></li>
          </ul>
        </nav>
        <!-- üîî N√∫t chu√¥ng th√¥ng b√°o -->
        <div id="notifyBell" class="relative cursor-pointer hover:text-indigo-600 transition">
          <i class="fa-solid fa-bell text-2xl"></i>
          <span id="notifyCount"
            class="absolute -top-1 -right-2 bg-red-500 text-white text-xs font-bold rounded-full w-4 h-4 flex items-center justify-center hidden">0</span>
        </div>
        <div id="notifyToast"
          class="fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-2 rounded shadow-lg transition-opacity duration-500 opacity-0 z-50">
        </div>

        <!-- Avatar -->
        <div class="relative">
          <button id="avatarButton" class="focus:outline-none">
            <img id="avatarImage" src="/components/Logo.png" alt="Avatar"
              class="w-10 h-10 rounded-full border-2 border-indigo-500 object-cover cursor-pointer hover:scale-110 transition-transform">
          </button>
          <div id="dropdownMenu"
            class="hidden absolute right-0 mt-3 w-52 bg-white rounded-xl shadow-lg py-2 border border-gray-100 z-50">
            <hr class="my-1">
            <a href="/info.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50">
              <i class="fa-solid fa-user mr-2 text-indigo-500"></i>Th√¥ng tin c√° nh√¢n
            </a>
            <a href="/fav.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50">
              <i class="fa-solid fa-heart mr-2 text-pink-500"></i>Y√™u th√≠ch
            </a>
            <a href="/error-report.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50">
              <i class="fa-solid fa-triangle-exclamation mr-2 text-yellow-500"></i>B√°o l·ªói
            </a>
            <div id="openLogoutModal" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 cursor-pointer">
              <i class="fa-solid fa-right-from-bracket mr-2"></i>ƒêƒÉng xu·∫•t
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- üîî Popup danh s√°ch th√¥ng b√°o -->
    <div id="notifyBox"
      class="hidden absolute right-6 top-16 w-80 bg-white shadow-xl rounded-xl overflow-hidden border border-gray-100 z-50">
      <div class="px-4 py-2 bg-indigo-600 text-white font-semibold">Th√¥ng b√°o</div>
      <ul id="notifyList" class="max-h-60 overflow-y-auto divide-y divide-gray-100"></ul>
    </div>
    </div>
  </header>

  <div id="logoutModal"
    class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
    <div
      class="bg-white rounded-lg shadow-xl w-full max-w-sm m-4 p-6 transform transition-all sm:my-8 sm:align-middle sm:max-w-lg">
      <div class="text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
          <i class="fa-solid fa-right-from-bracket text-red-600 text-xl"></i>
        </div>
        <h3 class="mt-4 text-lg leading-6 font-medium text-gray-900">X√°c nh·∫≠n ƒëƒÉng xu·∫•t</h3>
        <div class="mt-2">
          <p class="text-sm text-gray-500">
            B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh·ªèi t√†i kho·∫£n c·ªßa m√¨nh kh√¥ng?
          </p>
        </div>
      </div>
      <div class="mt-5 sm:mt-6 flex justify-end gap-3">
        <button id="cancelLogout" type="button"
          class="inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:text-sm">
          H·ªßy
        </button>
        <button id="confirmLogout" type="button"
          class="inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:text-sm">
          ƒêƒÉng xu·∫•t
        </button>
      </div>
    </div>
  </div>


  <!-- N·ªôi dung ch√≠nh -->
  <main class="flex-grow container mx-auto px-6 py-8">
    <h2 class="text-2xl font-bold text-indigo-700 mb-6">Danh s√°ch truy·ªán</h2>
    <div id="story-list" class="grid gap-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4"></div>

    <!-- Thanh ph√¢n trang -->
    <div id="pagination" class="flex justify-center items-center mt-8 gap-2"></div>
  </main>



  <!-- Modal ch·ªçn danh s√°ch y√™u th√≠ch -->
  <div id="favModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md animate-fade-in">
      <h2 class="text-lg font-semibold text-indigo-700 mb-4">
        Th√™m truy·ªán v√†o danh s√°ch y√™u th√≠ch
      </h2>

      <!-- Danh s√°ch y√™u th√≠ch hi·ªán c√≥ -->
      <div id="favListContainer" class="space-y-3 mb-4 text-gray-700 text-sm">
        <p class="text-gray-500 italic">ƒêang t·∫£i danh s√°ch...</p>
      </div>

      <!-- T·∫°o danh s√°ch m·ªõi -->
      <div class="flex justify-between items-center gap-3">
        <input id="newListName" type="text" placeholder="T·∫°o danh s√°ch m·ªõi..."
          class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring focus:ring-indigo-300 outline-none">
        <button id="createListBtn" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 text-sm">
          T·∫°o
        </button>
      </div>

      <!-- N√∫t ƒë√≥ng -->
      <div class="flex justify-end mt-4">
        <button id="closeFavModal" class="text-gray-600 hover:text-gray-800 font-medium text-sm">
          ƒê√≥ng
        </button>
      </div>
    </div>
  </div>

  <style>
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .animate-fade-in {
      animation: fadeIn 0.2s ease-out;
    }
  </style>
  <!-- Footer -->
  <footer class="bg-white mt-10 shadow-inner">
    <div class="container mx-auto py-6 px-6 flex flex-col md:flex-row justify-between items-center">
      <div class="flex items-center gap-2 mb-4 md:mb-0">
        <img src="/components/Logo.png" alt="Logo" class="w-8 h-8 rounded-full">
        <span class="font-bold text-indigo-600 text-lg">DH.story</span>
      </div>

      <div class="text-center md:text-right text-gray-600 text-sm">
        <p class="font-semibold text-gray-800 mb-1">LI√äN H·ªÜ V·ªöI T√îI</p>
        <a href="https://github.com/JahyuniJo" target="_blank"
          class="flex items-center justify-center md:justify-end gap-2 hover:text-indigo-600">
          <span>Github</span>
          <img src="/components/Github.jpg" alt="Github" class="w-5 h-5 rounded-full">
        </a>
        <p>Email: <a href="mailto:dieu300504@gmail.com" class="hover:text-indigo-600">dieu300504@gmail.com</a></p>
        <p class="mt-2 text-xs text-gray-400">¬© 2025 DieuHoang</p>
      </div>
    </div>
  </footer>



  <!-- Script -->
  <script src="/components/alertModal.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const notifyBell = document.getElementById("notifyBell");
    const notifyBox = document.getElementById("notifyBox");
    const notifyCount = document.getElementById("notifyCount");
    const notifyList = document.getElementById("notifyList");
    // üõéÔ∏è Th√¥ng b√°o realtime v·ªõi Socket.IO
    const socket = io("http://localhost:3000", {
      transports: ["websocket", "polling"]
    });

    let userEmail = null;

    // Khi socket k·∫øt n·ªëi th√†nh c√¥ng
    socket.on("connect", async () => {
      console.log("Connected to Socket Server:", socket.id);

      try {
        // L·∫•y th√¥ng tin user t·ª´ backend (JWT/Cookie)
        const res = await fetch("/api/import/me", {
          credentials: "include"
        });

        if (!res.ok) {
          console.warn("Kh√¥ng x√°c th·ª±c ƒë∆∞·ª£c user, kh√¥ng join socket.");
          return;
        }

        const user = await res.json();
        userEmail = user.email;

        // ƒêƒÉng k√Ω socket v·ªõi email th·∫≠t t·ª´ backend
        socket.emit("registerEmail", userEmail);

        // T·∫£i th√¥ng b√°o ban ƒë·∫ßu
        loadNotifications(userEmail);

      } catch (err) {
        console.error("L·ªói khi x√°c th·ª±c user:", err);
      }
    });

    // Nh·∫≠n th√¥ng b√°o realtime
    socket.on("newNotification", (data) => {
      console.log("Realtime Notification:", data);

      // TƒÉng badge
      unreadCount++;
      notifyCount.textContent = unreadCount;
      notifyCount.classList.remove("hidden");

      // Th√™m th√¥ng b√°o v√†o UI ngay l·∫≠p t·ª©c
      const li = document.createElement("li");
      li.className = "px-4 py-3 hover:bg-indigo-50 cursor-pointer transition";

      li.innerHTML = `
    <p class="text-sm text-gray-700">${data.message}</p>
    <p class="text-xs text-gray-400 mt-1">${new Date(data.time).toLocaleString()}</p>
  `;
      // Hi·ªáu ·ª©ng rung chu√¥ng
      ringBell();
      // Hi·ªÉn th·ªã toast
      showToast(data.message);
      notifyList.prepend(li);
    });

    // M·ªü UI th√¥ng b√°o , ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc
    notifyBell.addEventListener("click", async () => {
      notifyBox.classList.toggle("hidden");

      // N·∫øu m·ªü h·ªôp th√¥ng b√°o ‚Üí reset badge + mark as read
      if (!notifyBox.classList.contains("hidden") && userEmail) {

        unreadCount = 0;
        notifyCount.classList.add("hidden");

        try {
          const res = await fetch(`/api/notifications?email=${userEmail}`);
          const notifications = await res.json();

          // ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
          for (const n of notifications) {
            if (!n.is_read) {
              await fetch(`/api/notifications/${n.id}/read`, { method: "PUT" });
            }
          }

          // Reload UI
          renderNotificationList(notifications);

        } catch (err) {
          console.error("Kh√¥ng th·ªÉ mark-read:", err);
        }
      }
    });

    // load danh s√°ch th√¥ng b√°o
    async function loadNotifications(email) {
      try {
        const res = await fetch(`/api/notifications?email=${email}`);
        const notifications = await res.json();

        renderNotificationList(notifications);

      } catch (err) {
        console.error("L·ªói load th√¥ng b√°o:", err);
      }
    }


    // Render danh s√°ch th√¥ng b√°o
    function renderNotificationList(notifications) {
      notifyList.innerHTML = "";
      unreadCount = 0;

      notifications.forEach(noti => {
        const li = document.createElement("li");
        li.className = "px-4 py-3 hover:bg-indigo-50 cursor-pointer transition";

        li.innerHTML = `
      <p class="text-sm text-gray-700">${noti.message}</p>
      <p class="text-xs text-gray-400 mt-1">${new Date(noti.created_at).toLocaleString()}</p>
    `;

        notifyList.appendChild(li);

        if (!noti.is_read) unreadCount++;
      });

      if (unreadCount > 0) {
        notifyCount.textContent = unreadCount;
        notifyCount.classList.remove("hidden");
      } else {
        notifyCount.classList.add("hidden");
      }
    }


    // Th√™m notify realtime v√†o ƒë·∫ßu danh s√°ch
    function addRealtimeNotification(message) {
      const li = document.createElement("li");
      li.className = "px-4 py-3 hover:bg-indigo-50 cursor-pointer transition";

      li.innerHTML = `
    <p class="text-sm text-gray-700">${message}</p>
    <p class="text-xs text-gray-400 mt-1">(Realtime) ${new Date().toLocaleString()}</p>
  `;

      notifyList.prepend(li);
    }

    // Hi·ªáu ·ª©ng rung chu√¥ng
    function ringBell() {
      const icon = notifyBell.querySelector("i");
      if (!icon) return;

      icon.classList.add("animate-[ring_0.5s_ease]");
      setTimeout(() => icon.classList.remove("animate-[ring_0.5s_ease]"), 600);
    }

    // Hi·ªÉn th·ªã toast th√¥ng b√°o
    function showToast(text) {
      const toast = document.getElementById("notifyToast");
      if (!toast) return;

      toast.innerHTML = text;
      toast.classList.remove("opacity-0");

      setTimeout(() => {
        toast.classList.add("opacity-0");
      }, 3000);
    }

    // ü©∑ Y√™u th√≠ch - Th√™m truy·ªán v√†o danh s√°ch y√™u th√≠ch
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("favButton")?.addEventListener("click", openFavModal);
      document.getElementById("closeFavModal")?.addEventListener("click", closeFavModal);
    });
    let selectedStoryId = null;
    // G·ªçi API l·∫•y danh s√°ch y√™u th√≠ch hi·ªán c√≥
    async function getFavLists() {
      try {
        const res = await fetch("/api/favlists", { credentials: "include" });
        return res.ok ? await res.json() : [];
      } catch (err) {
        console.error("L·ªói l·∫•y danh s√°ch y√™u th√≠ch:", err);
        return [];
      }
    }

    // Hi·ªÉn th·ªã modal ch·ªçn danh s√°ch
    async function openFavModal(storyId) {
      selectedStoryId = storyId;
      const favLists = await getFavLists();
      const favListContainer = document.getElementById("favListContainer");

      if (!favLists.length) {
        favListContainer.innerHTML = `<p class="text-gray-500 text-sm">B·∫°n ch∆∞a c√≥ danh s√°ch n√†o. H√£y t·∫°o trong <a href="/fav.html" class="text-indigo-600 hover:underline">Y√™u th√≠ch</a>.</p>`;
      } else {
        favListContainer.innerHTML = favLists.map(
          (list) => `
      <button onclick="addStoryToList(${list.id}, '${list.name}')" 
        class="w-full text-left px-4 py-2 border border-gray-200 rounded hover:bg-indigo-50">
        <i class="fa-solid fa-heart mr-2 text-pink-500"></i>${list.name}
      </button>`
        ).join("");
      }

      document.getElementById("favModal").classList.remove("hidden");
    }

    function closeFavModal() {
      document.getElementById("favModal").classList.add("hidden");
      selectedStoryId = null;
    }


    // T·∫°o danh s√°ch y√™u th√≠ch m·ªõi
    async function createFavList() {
      const name = prompt("Nh·∫≠p t√™n danh s√°ch m·ªõi:");
      if (!name || !name.trim()) return;

      try {
        const res = await fetch("/api/favlists", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ name: name.trim() }),
        });

        const data = await res.json();
        if (res.ok) {
          showAlert("success", `ƒê√£ t·∫°o danh s√°ch "${name}"!`, "Th√†nh c√¥ng");
          // Sau khi t·∫°o xong, load l·∫°i danh s√°ch trong modal
          openFavModal(selectedStoryId);
        } else {
          showAlert("error", data.message || "L·ªói khi t·∫°o danh s√°ch!", "L·ªói");
        }
      } catch (err) {
        console.error("L·ªói khi t·∫°o danh s√°ch:", err);
        alert("L·ªói k·∫øt n·ªëi server!");
      }
    }
    const createListBtn = document.getElementById("createListBtn");
    const newListInput = document.getElementById("newListName");
    // Th√™m truy·ªán v√†o danh s√°ch y√™u th√≠ch
    createListBtn.addEventListener("click", async () => {
      const name = newListInput.value.trim();
      if (!name) return alert("Nh·∫≠p t√™n danh s√°ch!");

      try {
        const res = await fetch("/api/favlists", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
          body: JSON.stringify({ name }),
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.message || "Kh√¥ng th·ªÉ t·∫°o danh s√°ch");

        newListInput.value = "";
        showAlert("success", `ƒê√£ t·∫°o danh s√°ch "${name}"!`, "Th√†nh c√¥ng");
        openFavModal(selectedStoryId);
      } catch (err) {
        alert("‚ùå " + err.message);
      }
    });

    // ü©∑ H√†m th√™m truy·ªán v√†o danh s√°ch y√™u th√≠ch
    async function addStoryToList(listId, listName) {
      if (!selectedStoryId) {
        showAlert("error", "Kh√¥ng c√≥ truy·ªán n√†o ƒë∆∞·ª£c ch·ªçn!", "L·ªói");
        return;
      }

      try {
        const res = await fetch(`/api/favlists/${listId}/stories`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ storyId: selectedStoryId }),
        });

        const data = await res.json();

        if (res.ok) {
          showAlert("success", `ƒê√£ th√™m truy·ªán v√†o danh s√°ch "${listName}"!`, "Th√†nh c√¥ng");
          closeFavModal();
        } else {
          showAlert("info", data.message || "Truy·ªán ƒë√£ c√≥ trong danh s√°ch!", "Th√¥ng b√°o");
        }
      } catch (err) {
        console.error("L·ªói khi th√™m truy·ªán:", err);
        alert("L·ªói k·∫øt n·ªëi ƒë·∫øn server!");
      }
    }



    // Avatar dropdown menu
    const avatarBtn = document.getElementById('avatarButton');
    const dropdownMenu = document.getElementById('dropdownMenu');
    avatarBtn.addEventListener('click', () => dropdownMenu.classList.toggle('hidden'));
    window.addEventListener('click', (e) => {
      if (!avatarBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
        dropdownMenu.classList.add('hidden');
      }
    });

    async function loadUserAvatar() {
      try {
        const res = await fetch('/api/users/info');
        const data = await res.json();
        if (data.avatar_url) document.getElementById('avatarImage').src = data.avatar_url;
      } catch (err) {
        console.error('Kh√¥ng th·ªÉ t·∫£i avatar:', err);
      }
    }
    loadUserAvatar();


    // Ph√¢n trang + t·∫£i truy·ªán
    let currentPage = 1;
    const limit = 12;

    async function loadStories(page = 1, search = "") {
      try {
        const query = search ? `&q=${encodeURIComponent(search)}` : "";
        const res = await fetch(`/api/stories?page=${page}&limit=${limit}${query}`);
        const data = await res.json();
        const container = document.getElementById("story-list");
        container.innerHTML = (await Promise.all(
          data.stories.map(async (story) => {
            const res = await fetch(`/api/rating?story_id=${story.id}`);
            const rating = await res.json();

            return `
  <div class="bg-white rounded-2xl shadow-md overflow-hidden hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
    <a href="read2.html?id=${story.id}">
      <img src="${story.cover_url || '/default-cover.jpg'}" alt="${story.title}" 
           class="w-full h-56 object-cover hover:scale-105 transition-transform duration-500">
    </a>
    <div class="p-4">
      <a href="read2.html?id=${story.id}">
        <h3 class="text-lg font-semibold text-indigo-700 mb-1 truncate hover:underline">${story.title}</h3>
      </a>
      <p class="text-sm text-gray-600 mb-2">T√°c gi·∫£: ${story.author || "Kh√¥ng r√µ"}</p>
      <p class="text-xs text-gray-500 mb-2">Th·ªÉ lo·∫°i: ${story.genres || "Ch∆∞a r√µ"}</p>
      <p class="description collapsed text-sm text-gray-700 mb-2">${story.description || ""}</p>
      <button class="text-indigo-600 text-sm hover:underline" onclick="toggleDescription(this)">Xem th√™m</button>

      <!-- ü©∑ N√∫t y√™u th√≠ch -->
      <button onclick="openFavModal(${story.id})" 
              class="mt-3 px-3 py-1 text-sm bg-pink-100 text-pink-700 rounded-full hover:bg-pink-200">
        <i class="fa-solid fa-heart mr-1"></i>Y√™u th√≠ch
      </button>
      <p class="text-yellow-600 font-semibold mb-2">
            ‚≠ê ${rating.avg?.toFixed(1) || 0} / 5 (${rating.total || 0} ƒë√°nh gi√°)
          </p>
      <div class="mt-2 text-xs text-gray-500">
        <i class="fa-solid fa-eye"></i> ${story.view_count} l∆∞·ª£t ƒë·ªçc
      </div>
    </div>
  </div>
`;
          })
        )).join("");
        renderPagination(data.page, data.totalPages);
      } catch (err) {
        console.error("L·ªói t·∫£i truy·ªán:", err);
      }
    }

    function toggleDescription(button) {
      const desc = button.previousElementSibling;
      if (desc.classList.contains('collapsed')) {
        desc.classList.remove('collapsed');
        button.textContent = "Thu g·ªçn";
      } else {
        desc.classList.add('collapsed');
        button.textContent = "Xem th√™m";
      }
    }

    function renderPagination(current, total) {
      const pagination = document.getElementById("pagination");
      let html = "";

      html += `<button ${current === 1 ? "disabled" : `onclick="loadStories(${current - 1})"`}
        class="px-3 py-1 text-sm rounded-lg ${current === 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-indigo-600 hover:bg-indigo-100'}">¬´ Tr∆∞·ªõc</button>`;

      const maxButtons = 5;
      const half = Math.floor(maxButtons / 2);
      let start = Math.max(1, current - half);
      let end = Math.min(total, current + half);
      if (end - start < maxButtons - 1) {
        if (start === 1) end = Math.min(total, start + maxButtons - 1);
        else if (end === total) start = Math.max(1, total - maxButtons + 1);
      }

      if (start > 1) {
        html += `<button onclick="loadStories(1)" class="px-3 py-1 text-sm rounded-lg bg-white hover:bg-indigo-100">1</button>`;
        if (start > 2) html += `<span class="px-2 text-gray-500">‚Ä¶</span>`;
      }

      for (let i = start; i <= end; i++) {
        html += `<button onclick="loadStories(${i})"
          class="px-3 py-1 text-sm rounded-lg ${i === current ? 'bg-indigo-600 text-white' : 'bg-white text-indigo-600 hover:bg-indigo-100'}">${i}</button>`;
      }

      if (end < total) {
        if (end < total - 1) html += `<span class="px-2 text-gray-500">‚Ä¶</span>`;
        html += `<button onclick="loadStories(${total})" class="px-3 py-1 text-sm rounded-lg bg-white hover:bg-indigo-100">${total}</button>`;
      }

      html += `<button ${current === total ? "disabled" : `onclick="loadStories(${current + 1})"`}
        class="px-3 py-1 text-sm rounded-lg ${current === total ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-indigo-600 hover:bg-indigo-100'}">Sau ¬ª</button>`;

      pagination.innerHTML = `<div class="flex flex-wrap justify-center items-center gap-1 sm:gap-2">${html}</div>`;
    }

    loadStories();


    const logoutModal = document.getElementById('logoutModal');
    const openLogoutModal = document.getElementById('openLogoutModal');
    const cancelLogout = document.getElementById('cancelLogout');
    const confirmLogout = document.getElementById('confirmLogout');

    // H√†m hi·ªÉn th·ªã modal
    function showModal() {
      logoutModal.classList.remove('hidden');
    }

    // H√†m ·∫©n modal
    function hideModal() {
      logoutModal.classList.add('hidden');
    }

    // X·ª≠ l√Ω s·ª± ki·ªán m·ªü modal
    if (openLogoutModal) {
      openLogoutModal.addEventListener('click', showModal);
    }

    // X·ª≠ l√Ω s·ª± ki·ªán h·ªßy (ƒë√≥ng modal)
    if (cancelLogout) {
      cancelLogout.addEventListener('click', hideModal);
    }

    // X·ª≠ l√Ω s·ª± ki·ªán ƒêƒÇNG XU·∫§T TH·ª∞C S·ª∞
    if (confirmLogout) {
      confirmLogout.addEventListener('click', async () => {
        hideModal(); // ·∫®n modal ngay l·∫≠p t·ª©c

        try {
          const response = await fetch('/api/users/logout', {
            method: 'GET',
            credentials: 'include' // Quan tr·ªçng ƒë·ªÉ g·ª≠i HttpOnly Cookie
          });

          const data = await response.json();

          if (response.ok) {
            // ƒêƒÉng xu·∫•t th√†nh c√¥ng, chuy·ªÉn h∆∞·ªõng
            window.location.href = '/';
          } else {
            // L·ªói server (v√≠ d·ª•: token ƒë√£ h·∫øt h·∫°n, server kh√¥ng ph·∫£n h·ªìi ƒë√∫ng)
            alert(data.message || 'ƒêƒÉng xu·∫•t th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.');
          }
        } catch (error) {
          console.error('L·ªói k·∫øt n·ªëi khi ƒëƒÉng xu·∫•t:', error);
          alert('M·∫•t k·∫øt n·ªëi v·ªõi m√°y ch·ªß khi ƒëƒÉng xu·∫•t.');
          // ƒê·∫£m b·∫£o ng∆∞·ªùi d√πng bi·∫øt, nh∆∞ng kh√¥ng th·ªÉ l√†m g√¨ h∆°n ·ªü client
        }
      });
    }


    /* ==========================
   üîç SEARCH + POPOVER LOGIC
   ========================== */
    const searchBox = document.getElementById("searchBox");
    const searchBtn = document.getElementById("searchBtn");
    const suggestionBox = document.getElementById("searchSuggestions");
    let typingTimer;

    // üß† H√†m debounce tr√°nh spam API
    function debounce(func, delay) {
      clearTimeout(typingTimer);
      typingTimer = setTimeout(func, delay);
    }

    // üìå G·ªçi API g·ª£i √Ω Elasticsearch
    async function fetchSuggestions(q) {
      if (!q.trim()) {
        suggestionBox.classList.add("hidden");
        return;
      }

      try {
        const res = await fetch(`/api/stories/search?q=${encodeURIComponent(q)}`);
        const data = await res.json();

        if (!data.length) {
          suggestionBox.innerHTML = `<p class="p-3 text-gray-500 text-sm">Kh√¥ng t√¨m th·∫•y...</p>`;
          suggestionBox.classList.remove("hidden");
          return;
        }

        // T·∫°o danh s√°ch g·ª£i √Ω
        suggestionBox.innerHTML = data.map(item => `
      <div onclick="openStory(${item.id})"
           class="flex items-center p-2 hover:bg-indigo-50 cursor-pointer">
        <img src="${item.cover_url || '/default-cover.jpg'}" class="w-10 h-14 object-cover rounded mr-3">
        <div>
          <p class="font-medium text-indigo-700">${item.title}</p>
          <p class="text-xs text-gray-500">${item.author || "Kh√¥ng r√µ t√°c gi·∫£"}</p>
        </div>
      </div>
    `).join("");

        suggestionBox.classList.remove("hidden");

      } catch (err) {
        console.error("‚ùå L·ªói fetchSuggest:", err);
      }
    }
    // üìå M·ªü truy·ªán khi ch·ªçn g·ª£i √Ω
    window.openStory = function (id) {
      window.location.href = `/read2.html?id=${id}`;
    };

    // üìå Ch·ªçn g·ª£i √Ω ‚Üí search ngay
    window.selectSuggestion = function (title) {
      searchBox.value = title;
      suggestionBox.classList.add("hidden");
      loadStories(1, title);
    };

    // ‚å® Khi ng∆∞·ªùi d√πng g√µ ‚Üí g·ªçi API g·ª£i √Ω
    searchBox.addEventListener("input", () => {
      debounce(() => fetchSuggestions(searchBox.value), 200);
    });

    // ‚èé Enter ‚Üí t√¨m ki·∫øm
    searchBox.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        suggestionBox.classList.add("hidden");
        loadStories(1, searchBox.value.trim());
      }
    });

    // üîç Click n√∫t t√¨m ki·∫øm
    searchBtn.addEventListener("click", () => {
      suggestionBox.classList.add("hidden");
      loadStories(1, searchBox.value.trim());
    });

    // ·∫®n popover khi click ra ngo√†i
    document.addEventListener("click", (e) => {
      if (!searchBox.contains(e.target) && !suggestionBox.contains(e.target)) {
        suggestionBox.classList.add("hidden");
      }
    });

  </script>
</body>

</html>