<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ƒê·ªçc truy·ªán | DH.story</title>
  <link rel="icon" type="image/png" href="/components/Logo.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeIn 0.8s ease-in forwards;
    }

    .cover {
      transition: transform 0.4s ease, box-shadow 0.4s ease;
    }

    .cover:hover {
      transform: scale(1.03);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .title-hover:hover {
      color: #4f46e5;
      text-shadow: 0 0 10px rgba(79, 70, 229, 0.2);
    }

    @keyframes ring {
      0% {
        transform: rotate(0);
      }

      20% {
        transform: rotate(-15deg);
      }

      40% {
        transform: rotate(15deg);
      }

      60% {
        transform: rotate(-10deg);
      }

      80% {
        transform: rotate(10deg);
      }

      100% {
        transform: rotate(0);
      }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex flex-col font-sans">
  <!-- Header -->
  <header class="bg-white shadow-md">
    <div class="container mx-auto flex flex-col md:flex-row items-center justify-between py-4 px-6">

      <!-- Logo -->
      <div class="flex items-center gap-2">
        <a href="index2.html" class="flex items-center gap-2">
          <img src="/components/Logo.png" alt="Logo" class="w-10 h-10 rounded-full">
          <span class="text-2xl font-bold text-indigo-600">DH.story</span>
        </a>
      </div>

      <!-- Slogan -->
      <p class="italic text-gray-500 text-sm md:text-base mt-2 md:mt-0">
        Ch√∫c c√°c b·∫°n ƒë·ªçc truy·ªán vui v·∫ª!
      </p>
      <!-- Search -->
      <div class="relative">
        <div class="flex items-center bg-gray-100 rounded-full overflow-hidden shadow-inner">
          <input id="searchBox" type="text" placeholder="T√¨m ki·∫øm truy·ªán..."
            class="px-4 py-2 bg-transparent focus:outline-none w-48 md:w-64 text-gray-700">
          <button id="searchBtn" class="px-3 text-indigo-600 hover:text-indigo-800" aria-label="T√¨m ki·∫øm">
            <i class="fa-solid fa-magnifying-glass"></i>
          </button>
        </div>

        <!-- Popover k·∫øt qu·∫£ -->
        <div id="searchSuggestions"
          class="absolute left-0 right-0 bg-white shadow-lg rounded-lg mt-1 hidden max-h-64 overflow-y-auto z-50 border border-gray-200">
        </div>
      </div>


      <!-- Menu -->
      <nav>
        <ul class="flex flex-wrap justify-center md:justify-start gap-4 text-sm font-medium text-gray-700">
          <li><a href="Truy·ªán h√†i.html" class="hover:text-indigo-600">Truy·ªán h√†i</a></li>
          <li><a href="Truy·ªán ng√¥n t√¨nh.html" class="hover:text-indigo-600">Truy·ªán ng√¥n t√¨nh</a></li>
          <li><a href="Truy·ªán kinh d·ªã.html" class="hover:text-indigo-600">Truy·ªán kinh d·ªã</a></li>
          <li><a href="Truy·ªán trinh th√°m.html" class="hover:text-indigo-600">Truy·ªán trinh th√°m</a></li>
        </ul>
      </nav>

      <!-- üîî N√∫t chu√¥ng th√¥ng b√°o -->
      <div id="notifyBell" class="relative cursor-pointer hover:text-indigo-600 transition">
        <i class="fa-solid fa-bell text-2xl"></i>
        <span id="notifyCount"
          class="absolute -top-1 -right-2 bg-red-500 text-white text-xs font-bold rounded-full w-4 h-4 flex items-center justify-center hidden">0</span>
      </div>
      <div id="notifyToast"
        class="fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-2 rounded shadow-lg transition-opacity duration-500 opacity-0 z-50">
      </div>
      <!-- Avatar -->
      <div class="relative">
        <button id="avatarButton" class="focus:outline-none">
          <img id="avatarImage" src="/components/Logo.png" alt="Avatar"
            class="w-10 h-10 rounded-full border-2 border-indigo-500 object-cover cursor-pointer hover:scale-110 transition-transform">
        </button>
        <div id="dropdownMenu"
          class="hidden absolute right-0 mt-3 w-52 bg-white rounded-xl shadow-lg py-2 border border-gray-100 z-50">
          <hr class="my-1">
          <a href="/info.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50">
            <i class="fa-solid fa-user mr-2 text-indigo-500"></i>Th√¥ng tin c√° nh√¢n
          </a>
          <a href="/fav.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50">
            <i class="fa-solid fa-heart mr-2 text-pink-500"></i>Y√™u th√≠ch
          </a>
          <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50">
            <i class="fa-solid fa-triangle-exclamation mr-2 text-yellow-500"></i>B√°o l·ªói
          </a>
          <div id="openLogoutModal" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 cursor-pointer">
            <i class="fa-solid fa-right-from-bracket mr-2"></i>ƒêƒÉng xu·∫•t
          </div>
        </div>
      </div>

    </div>
    </div>

    <!-- üîî Popup danh s√°ch th√¥ng b√°o -->
    <div id="notifyBox"
      class="hidden absolute right-6 top-16 w-80 bg-white shadow-xl rounded-xl overflow-hidden border border-gray-100 z-50">
      <div class="px-4 py-2 bg-indigo-600 text-white font-semibold">Th√¥ng b√°o</div>
      <ul id="notifyList" class="max-h-60 overflow-y-auto divide-y divide-gray-100"></ul>
    </div>
    </div>
  </header>


  <div id="logoutModal"
    class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
    <div
      class="bg-white rounded-lg shadow-xl w-full max-w-sm m-4 p-6 transform transition-all sm:my-8 sm:align-middle sm:max-w-lg">
      <div class="text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
          <i class="fa-solid fa-right-from-bracket text-red-600 text-xl"></i>
        </div>
        <h3 class="mt-4 text-lg leading-6 font-medium text-gray-900">X√°c nh·∫≠n ƒëƒÉng xu·∫•t</h3>
        <div class="mt-2">
          <p class="text-sm text-gray-500">
            B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh·ªèi t√†i kho·∫£n c·ªßa m√¨nh kh√¥ng?
          </p>
        </div>
      </div>
      <div class="mt-5 sm:mt-6 flex justify-end gap-3">
        <button id="cancelLogout" type="button"
          class="inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:text-sm">
          H·ªßy
        </button>
        <button id="confirmLogout" type="button"
          class="inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:text-sm">
          ƒêƒÉng xu·∫•t
        </button>
      </div>
    </div>
  </div>



  <!-- MAIN -->
  <main class="flex-1 container mx-auto py-10 px-6 fade-in">
    <div id="story-container" class="bg-white shadow-lg rounded-2xl p-8 flex flex-col md:flex-row gap-8">

      <!-- ·∫¢nh b√¨a -->
      <div class="flex-shrink-0 self-center">
        <img id="story-cover" src="" alt="B√¨a truy·ªán" class="w-56 h-80 object-cover rounded-xl cover" />
      </div>

      <!-- N·ªôi dung truy·ªán -->
      <div class="flex-1">
        <h1 id="story-title" class="text-3xl font-bold text-indigo-700 mb-2 title-hover"></h1>
        <p id="story-rating" class="text-yellow-600 font-semibold mb-4"></p>
        <p id="story-author" class="text-gray-600 mb-4 italic"></p>
        <p id="story-genres" class="text-sm text-gray-500 mb-6"></p>
        <a id="story-link" href="#" target="_blank"
          class="inline-block bg-indigo-600 text-white font-semibold px-5 py-2 rounded-xl shadow-md hover:bg-indigo-700 transition duration-300 mb-6">
          üìñ ƒê·ªçc truy·ªán g·ªëc
        </a>
        <button id="favButton"
          class="inline-flex items-center gap-2 bg-pink-500 text-white font-semibold px-5 py-2 rounded-xl shadow-md hover:bg-pink-600 transition duration-300">
          <i class="fa-solid fa-heart"></i> Y√™u th√≠ch
        </button>
        <button id="rateButton"
          class="inline-flex items-center gap-2 bg-yellow-500 text-white font-semibold px-5 py-2 rounded-xl shadow-md hover:bg-yellow-600 transition duration-300">
          <i class="fa-solid fa-star"></i> ƒê√°nh gi√°
        </button>

        <div id="story-content" class="leading-relaxed text-gray-800 text-justify whitespace-pre-line"></div>
      </div>
    </div>


    <!-- COMMENT SECTION -->
    <div class="mt-10 bg-white shadow-lg p-6 rounded-xl">

      <h2 class="text-xl font-bold text-gray-800 mb-4">üí¨ B√¨nh lu·∫≠n</h2>

      <!-- Form comment -->
      <textarea id="commentInput" placeholder="Vi·∫øt b√¨nh lu·∫≠n..."
        class="w-full border rounded-lg p-3 focus:ring focus:ring-indigo-300 outline-none"></textarea>

      <button id="sendComment" class="mt-3 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
        G·ª≠i b√¨nh lu·∫≠n
      </button>

      <!-- Comment list -->
      <div id="commentList" class="mt-6 space-y-4"></div>
    </div>
  </main>


  <!--Modal danh s√°ch y√™u th√≠ch-->
  <div id="favModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">
      <h2 class="text-lg font-semibold text-indigo-700 mb-4">Th√™m truy·ªán v√†o danh s√°ch y√™u th√≠ch</h2>
      <div id="favListContainer" class="space-y-3 mb-4 text-gray-700 text-sm">
        <p class="text-gray-500 italic">ƒêang t·∫£i danh s√°ch...</p>
      </div>
      <div class="flex justify-between items-center gap-3">
        <input id="newListName" type="text" placeholder="T·∫°o danh s√°ch m·ªõi..."
          class="flex-1 border rounded-lg px-3 py-2 text-sm focus:ring focus:ring-indigo-300 outline-none">
        <button id="createListBtn" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 text-sm">
          T·∫°o
        </button>
      </div>
      <div class="flex justify-end mt-4">
        <button id="closeFavModal" class="text-gray-600 hover:text-gray-800 font-medium text-sm">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <!--Modal ƒë√°nh gi√° -->
  <div id="rateModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">

      <h2 class="text-lg font-semibold text-yellow-600 mb-4">ƒê√°nh gi√° truy·ªán</h2>

      <div class="text-center mb-4">
        <div id="starSelect" class="flex justify-center gap-2 text-3xl text-gray-400 cursor-pointer">
          <i data-rate="1" class="fa-solid fa-star hover:text-yellow-400"></i>
          <i data-rate="2" class="fa-solid fa-star hover:text-yellow-400"></i>
          <i data-rate="3" class="fa-solid fa-star hover:text-yellow-400"></i>
          <i data-rate="4" class="fa-solid fa-star hover:text-yellow-400"></i>
          <i data-rate="5" class="fa-solid fa-star hover:text-yellow-400"></i>
        </div>
      </div>

      <div class="flex justify-end mt-4">
        <button id="submitRating" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
          G·ª≠i ƒë√°nh gi√°
        </button>
        <button id="closeRateModal" class="ml-3 text-gray-600 hover:text-gray-800">
          ƒê√≥ng
        </button>
      </div>

    </div>
  </div>


  <!-- Footer -->
  <footer class="bg-white mt-10 shadow-inner">
    <div class="container mx-auto py-6 px-6 flex flex-col md:flex-row justify-between items-center">
      <div class="flex items-center gap-2 mb-4 md:mb-0">
        <img src="/components/Logo.png" alt="Logo" class="w-8 h-8 rounded-full">
        <span class="font-bold text-indigo-600 text-lg">DH.story</span>
      </div>

      <div class="text-center md:text-right text-gray-600 text-sm">
        <p class="font-semibold text-gray-800 mb-1">LI√äN H·ªÜ V·ªöI T√îI</p>
        <a href="https://github.com/JahyuniJo" target="_blank"
          class="flex items-center justify-center md:justify-end gap-2 hover:text-indigo-600">
          <span>Github</span>
          <img src="/components/Github.jpg" alt="Github" class="w-5 h-5 rounded-full">
        </a>
        <p>Email: <a href="mailto:dieu300504@gmail.com" class="hover:text-indigo-600">dieu300504@gmail.com</a></p>
        <p class="mt-2 text-xs text-gray-400">¬© 2025 DieuHoang</p>
      </div>
    </div>
  </footer>
  <script src="/components/alertModal.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    // =============================
    // SOCKET.IO CLIENT
    // =============================
    const socket = io("http://localhost:3000", {
      transports: ["websocket", "polling"]
    });

    let userEmail = null;

    // Khi socket k·∫øt n·ªëi th√†nh c√¥ng
    socket.on("connect", async () => {
      console.log("Connected to Socket Server:", socket.id);

      try {
        // L·∫•y th√¥ng tin user t·ª´ backend (JWT/Cookie)
        const res = await fetch("/api/import/me", {
          credentials: "include"
        });

        if (!res.ok) {
          console.warn("Kh√¥ng x√°c th·ª±c ƒë∆∞·ª£c user, kh√¥ng join socket.");
          return;
        }

        const user = await res.json();
        userEmail = user.email;

        // ƒêƒÉng k√Ω socket v·ªõi email th·∫≠t t·ª´ backend
        socket.emit("registerEmail", userEmail);

        // T·∫£i th√¥ng b√°o ban ƒë·∫ßu
        loadNotifications(userEmail);

      } catch (err) {
        console.error("L·ªói khi x√°c th·ª±c user:", err);
      }
    });

    // Nh·∫≠n th√¥ng b√°o realtime
    socket.on("newNotification", (data) => {
      console.log("Realtime Notification:", data);

      // TƒÉng badge
      unreadCount++;
      notifyCount.textContent = unreadCount;
      notifyCount.classList.remove("hidden");

      // Th√™m th√¥ng b√°o v√†o UI ngay l·∫≠p t·ª©c
      const li = document.createElement("li");
      li.className = "px-4 py-3 hover:bg-indigo-50 cursor-pointer transition";

      li.innerHTML = `
    <p class="text-sm text-gray-700">${data.message}</p>
    <p class="text-xs text-gray-400 mt-1">${new Date(data.time).toLocaleString()}</p>
  `;
      // Hi·ªáu ·ª©ng rung chu√¥ng
      ringBell();
      // Hi·ªÉn th·ªã toast
      showToast(data.message);
      notifyList.prepend(li);
    });


    const favBtn = document.getElementById("favButton");
    const favModal = document.getElementById("favModal");
    const favListContainer = document.getElementById("favListContainer");
    const newListInput = document.getElementById("newListName");
    const createListBtn = document.getElementById("createListBtn");
    const closeFavModal = document.getElementById("closeFavModal");
    const notifyBell = document.getElementById("notifyBell");
    const notifyBox = document.getElementById("notifyBox");
    const notifyCount = document.getElementById("notifyCount");
    const notifyList = document.getElementById("notifyList");
    // M·ªü UI th√¥ng b√°o , ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc
    notifyBell.addEventListener("click", async () => {
      notifyBox.classList.toggle("hidden");

      // N·∫øu m·ªü h·ªôp th√¥ng b√°o ‚Üí reset badge + mark as read
      if (!notifyBox.classList.contains("hidden") && userEmail) {

        unreadCount = 0;
        notifyCount.classList.add("hidden");

        try {
          const res = await fetch(`/api/notifications?email=${userEmail}`);
          const notifications = await res.json();

          // ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
          for (const n of notifications) {
            if (!n.is_read) {
              await fetch(`/api/notifications/${n.id}/read`, { method: "PUT" });
            }
          }

          // Reload UI
          renderNotificationList(notifications);

        } catch (err) {
          console.error("Kh√¥ng th·ªÉ mark-read:", err);
        }
      }
    });

    // load danh s√°ch th√¥ng b√°o
    async function loadNotifications(email) {
      try {
        const res = await fetch(`/api/notifications?email=${email}`);
        const notifications = await res.json();

        renderNotificationList(notifications);

      } catch (err) {
        console.error("L·ªói load th√¥ng b√°o:", err);
      }
    }


    // Render danh s√°ch th√¥ng b√°o
    function renderNotificationList(notifications) {
      notifyList.innerHTML = "";
      unreadCount = 0;

      notifications.forEach(noti => {
        const li = document.createElement("li");
        li.className = "px-4 py-3 hover:bg-indigo-50 cursor-pointer transition";

        li.innerHTML = `
      <p class="text-sm text-gray-700">${noti.message}</p>
      <p class="text-xs text-gray-400 mt-1">${new Date(noti.created_at).toLocaleString()}</p>
    `;

        notifyList.appendChild(li);

        if (!noti.is_read) unreadCount++;
      });

      if (unreadCount > 0) {
        notifyCount.textContent = unreadCount;
        notifyCount.classList.remove("hidden");
      } else {
        notifyCount.classList.add("hidden");
      }
    }


    // Th√™m notify realtime v√†o ƒë·∫ßu danh s√°ch
    function addRealtimeNotification(message) {
      const li = document.createElement("li");
      li.className = "px-4 py-3 hover:bg-indigo-50 cursor-pointer transition";

      li.innerHTML = `
    <p class="text-sm text-gray-700">${message}</p>
    <p class="text-xs text-gray-400 mt-1">(Realtime) ${new Date().toLocaleString()}</p>
  `;

      notifyList.prepend(li);
    }

    // Hi·ªáu ·ª©ng rung chu√¥ng
    function ringBell() {
      const icon = notifyBell.querySelector("i");
      if (!icon) return;

      icon.classList.add("animate-[ring_0.5s_ease]");
      setTimeout(() => icon.classList.remove("animate-[ring_0.5s_ease]"), 600);
    }

    // Hi·ªÉn th·ªã toast th√¥ng b√°o
    function showToast(text) {
      const toast = document.getElementById("notifyToast");
      if (!toast) return;

      toast.innerHTML = text;
      toast.classList.remove("opacity-0");

      setTimeout(() => {
        toast.classList.add("opacity-0");
      }, 3000);
    }


    // L·∫•y ID truy·ªán hi·ªán t·∫°i t·ª´ URL (?id=)
    function getStoryId() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    // M·ªü modal ch·ªçn danh s√°ch y√™u th√≠ch
    favBtn.addEventListener("click", async () => {
      favModal.classList.remove("hidden");
      favListContainer.innerHTML = `<p class="text-gray-500 italic">ƒêang t·∫£i danh s√°ch...</p>`;

      try {

        const res = await fetch("/api/favlists", {
          headers: { "Content-Type": "application/json", },
          credentials: "include",
        });
        if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch");

        const lists = await res.json();

        if (lists.length === 0) {
          favListContainer.innerHTML = `<p class="text-gray-500 text-sm italic">B·∫°n ch∆∞a c√≥ danh s√°ch n√†o. H√£y t·∫°o m·ªõi ·ªü d∆∞·ªõi!</p>`;
        } else {
          favListContainer.innerHTML = lists.map(
            list => `
          <button onclick="addStoryToList(${list.id}, '${list.name.replace(/'/g, "\\'")}')"

                  class="block w-full text-left border border-gray-200 rounded-lg px-3 py-2 hover:bg-indigo-50 transition">
            <i class="fa-solid fa-heart text-pink-500 mr-2"></i>${list.name}
          </button>`
          ).join("");
        }
      } catch (err) {
        console.error(err);
        favListContainer.innerHTML = `<p class="text-red-500 text-sm">L·ªói t·∫£i danh s√°ch!</p>`;
      }
    });

    // ƒê√≥ng modal
    closeFavModal.addEventListener("click", () => favModal.classList.add("hidden"));

    // T·∫°o danh s√°ch m·ªõi
    createListBtn.addEventListener("click", async () => {
      const name = newListInput.value.trim();
      if (!name) return showAlert("warning", "Vui l√≤ng nh·∫≠p t√™n danh s√°ch!", "C·∫£nh b√°o");

      try {
        const res = await fetch("/api/favlists", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
          body: JSON.stringify({ name }),
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.message || "Kh√¥ng th·ªÉ t·∫°o danh s√°ch");

        newListInput.value = "";
        showAlert("success", `ƒê√£ t·∫°o danh s√°ch "${name}"!`, "Th√†nh c√¥ng");
        favBtn.click(); // reload l·∫°i modal
      } catch (err) {
        alert("‚ùå " + err.message);
      }
    });

    // Th√™m truy·ªán v√†o danh s√°ch
    async function addStoryToList(listId, listName) {
      const storyId = getStoryId();
      if (!storyId) return showAlert("error", "ID truy·ªán kh√¥ng h·ª£p l·ªá!", "L·ªói");

      try {
        const res = await fetch(`/api/favlists/${listId}/stories`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ storyId }),
        });

        const data = await res.json();
        if (res.ok) {
          showAlert("success", `ƒê√£ th√™m truy·ªán v√†o danh s√°ch "${listName}"!`, "Th√†nh c√¥ng");
          favModal.classList.add("hidden");
        } else {
          showAlert("info", data.message || "Truy·ªán ƒë√£ c√≥ trong danh s√°ch!", "Th√¥ng b√°o");
        }
      } catch (err) {
        console.error("‚ùå L·ªói th√™m truy·ªán:", err);
        alert("L·ªói k·∫øt n·ªëi server!");
      }
    }


    // --- Avatar dropdown menu ---
    const avatarBtn = document.getElementById('avatarButton');
    const dropdownMenu = document.getElementById('dropdownMenu');
    avatarBtn.addEventListener('click', () => dropdownMenu.classList.toggle('hidden'));
    window.addEventListener('click', (e) => {
      if (!avatarBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
        dropdownMenu.classList.add('hidden');
      }
    });

    async function loadUserAvatar() {
      try {
        const res = await fetch('/api/users/info');
        const data = await res.json();
        if (data.avatar_url) document.getElementById('avatarImage').src = data.avatar_url;
      } catch (err) {
        console.error('Kh√¥ng th·ªÉ t·∫£i avatar:', err);
      }
    }
    loadUserAvatar();


    // G·ªçi API l·∫•y chi ti·∫øt truy·ªán
    async function loadStory() {
      const id = getStoryId();
      if (!id) return;

      try {
        const res = await fetch(`/api/stories/${id}`);
        const story = await res.json();

        document.getElementById("story-cover").src = story.cover_url;
        document.getElementById("story-title").textContent = story.title;
        document.getElementById("story-author").textContent = "T√°c gi·∫£: " + story.author;
        document.getElementById("story-genres").textContent = "Th·ªÉ lo·∫°i: " + story.genres;
        document.getElementById("story-content").textContent = story.description;
        const link = document.getElementById("story-link");
        link.href = story.url;
        if (!story.url) link.classList.add("hidden");
      } catch (err) {
        console.error("L·ªói t·∫£i truy·ªán:", err);
      }
    }

    loadStory();



    // --- ƒêƒÉng xu·∫•t ---
    const logoutModal = document.getElementById('logoutModal');
    const openLogoutModal = document.getElementById('openLogoutModal');
    const cancelLogout = document.getElementById('cancelLogout');
    const confirmLogout = document.getElementById('confirmLogout');
    function showModal() {
      logoutModal.classList.remove('hidden');
    }

    // H√†m ·∫©n modal
    function hideModal() {
      logoutModal.classList.add('hidden');
    }

    // X·ª≠ l√Ω s·ª± ki·ªán m·ªü modal
    if (openLogoutModal) {
      openLogoutModal.addEventListener('click', showModal);
    }

    // X·ª≠ l√Ω s·ª± ki·ªán h·ªßy (ƒë√≥ng modal)
    if (cancelLogout) {
      cancelLogout.addEventListener('click', hideModal);
    }
    // ƒêƒÉng xu·∫•t
    if (confirmLogout) {
      confirmLogout.addEventListener('click', async () => {
        hideModal(); // ·∫®n modal ngay l·∫≠p t·ª©c

        try {
          const response = await fetch('/api/users/logout', {
            method: 'GET',
            credentials: 'include' // Quan tr·ªçng ƒë·ªÉ g·ª≠i HttpOnly Cookie
          });

          const data = await response.json();

          if (response.ok) {
            // ƒêƒÉng xu·∫•t th√†nh c√¥ng, chuy·ªÉn h∆∞·ªõng
            window.location.href = '/';
          } else {
            // L·ªói server (v√≠ d·ª•: token ƒë√£ h·∫øt h·∫°n, server kh√¥ng ph·∫£n h·ªìi ƒë√∫ng)
            alert(data.message || 'ƒêƒÉng xu·∫•t th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.');
          }
        } catch (error) {
          console.error('L·ªói k·∫øt n·ªëi khi ƒëƒÉng xu·∫•t:', error);
          alert('M·∫•t k·∫øt n·ªëi v·ªõi m√°y ch·ªß khi ƒëƒÉng xu·∫•t.');
          // ƒê·∫£m b·∫£o ng∆∞·ªùi d√πng bi·∫øt, nh∆∞ng kh√¥ng th·ªÉ l√†m g√¨ h∆°n ·ªü client
        }
      });
    }


    /* ==========================
  üîç SEARCH + POPOVER LOGIC
  ========================== */
    const searchBox = document.getElementById("searchBox");
    const searchBtn = document.getElementById("searchBtn");
    const suggestionBox = document.getElementById("searchSuggestions");
    let typingTimer;

    // üß† H√†m debounce tr√°nh spam API
    function debounce(func, delay) {
      clearTimeout(typingTimer);
      typingTimer = setTimeout(func, delay);
    }

    // üìå G·ªçi API g·ª£i √Ω Elasticsearch
    async function fetchSuggestions(q) {
      if (!q.trim()) {
        suggestionBox.classList.add("hidden");
        return;
      }

      try {
        const res = await fetch(`/api/stories/search?q=${encodeURIComponent(q)}`);
        const data = await res.json();

        if (!data.length) {
          suggestionBox.innerHTML = `<p class="p-3 text-gray-500 text-sm">Kh√¥ng t√¨m th·∫•y...</p>`;
          suggestionBox.classList.remove("hidden");
          return;
        }

        // T·∫°o danh s√°ch g·ª£i √Ω
        suggestionBox.innerHTML = data.map(item => `
      <div onclick="openStory(${item.id})"
           class="flex items-center p-2 hover:bg-indigo-50 cursor-pointer">
        <img src="${item.cover_url || '/default-cover.jpg'}" class="w-10 h-14 object-cover rounded mr-3">
        <div>
          <p class="font-medium text-indigo-700">${item.title}</p>
          <p class="text-xs text-gray-500">${item.author || "Kh√¥ng r√µ t√°c gi·∫£"}</p>
        </div>
      </div>
    `).join("");

        suggestionBox.classList.remove("hidden");

      } catch (err) {
        console.error("‚ùå L·ªói fetchSuggest:", err);
      }
    }
    // üìå M·ªü truy·ªán khi ch·ªçn g·ª£i √Ω
    window.openStory = function (id) {
      window.location.href = `/read2.html?id=${id}`;
    };

    // üìå Ch·ªçn g·ª£i √Ω ‚Üí search ngay
    window.selectSuggestion = function (title) {
      searchBox.value = title;
      suggestionBox.classList.add("hidden");
      loadStories(1, title);
    };

    // ‚å® Khi ng∆∞·ªùi d√πng g√µ ‚Üí g·ªçi API g·ª£i √Ω
    searchBox.addEventListener("input", () => {
      debounce(() => fetchSuggestions(searchBox.value), 200);
    });

    // ‚èé Enter ‚Üí t√¨m ki·∫øm
    searchBox.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        suggestionBox.classList.add("hidden");
        loadStories(1, searchBox.value.trim());
      }
    });

    // üîç Click n√∫t t√¨m ki·∫øm
    searchBtn.addEventListener("click", () => {
      suggestionBox.classList.add("hidden");
      loadStories(1, searchBox.value.trim());
    });

    // ·∫®n popover khi click ra ngo√†i
    document.addEventListener("click", (e) => {
      if (!searchBox.contains(e.target) && !suggestionBox.contains(e.target)) {
        suggestionBox.classList.add("hidden");
      }
    });



    /* ==========================
       ‚≠ê RATING LOGIC
    ========================== */

    const rateBtn = document.getElementById("rateButton");
    const rateModal = document.getElementById("rateModal");
    const closeRateModal = document.getElementById("closeRateModal");
    const submitRating = document.getElementById("submitRating");
    const starSelect = document.getElementById("starSelect");

    let selectedRating = 0;

    // M·ªü modal
    rateBtn.addEventListener("click", () => {
      rateModal.classList.remove("hidden");
    });

    // ƒê√≥ng modal
    closeRateModal.addEventListener("click", () => {
      rateModal.classList.add("hidden");
    });

    // Ch·ªçn sao
    starSelect.querySelectorAll("i").forEach(star => {
      star.addEventListener("click", () => {
        selectedRating = star.dataset.rate;

        // Highlight sao
        starSelect.querySelectorAll("i").forEach(s => {
          s.classList.remove("text-yellow-400");
          if (s.dataset.rate <= selectedRating) s.classList.add("text-yellow-400");
        });
      });
    });

    // G·ª≠i rating
    submitRating.addEventListener("click", async () => {
      if (selectedRating === 0)
        return showAlert("warning", "Vui l√≤ng ch·ªçn s·ªë sao!", "Ch∆∞a ch·ªçn sao");

      const storyId = getStoryId();

      const res = await fetch("/api/rating", {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ story_id: storyId, rating: selectedRating }),
      });

      const data = await res.json();

      if (res.ok) {
        showAlert("success", "ƒê√°nh gi√° th√†nh c√¥ng!", "Th√†nh c√¥ng");
        rateModal.classList.add("hidden");
        loadRating(); // refresh UI
      }
    });

    async function loadRating() {
      const id = getStoryId();
      const res = await fetch(`/api/rating?story_id=${id}`);
      const data = await res.json();

      document.getElementById("story-rating").innerHTML =
        `‚≠ê ${data.avg.toFixed(1)} / 5 (${data.total} ƒë√°nh gi√°)`;
    }

    loadRating();

    let currentUserId = null;

    // COMMENT LOGIC

    document.getElementById("sendComment").addEventListener("click", async () => {
      const content = document.getElementById("commentInput").value;
      const storyId = new URLSearchParams(location.search).get("id");

      const res = await fetch("/api/comments", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ story_id: storyId, content })
      });

      if (res.ok) {
        document.getElementById("commentInput").value = "";
        loadComments(storyId);
      }
    });

    function renderComment(c, level = 0) {
      return `
  <div id="comment-${c.id}" class="mt-4 ${level > 0 ? "ml-10 border-l pl-4" : ""} relative">


    <div class="flex items-start gap-3">

      <!-- Avatar -->
      <img src="${c.avatar_url || "/components/Logo.png"}"
           class="w-10 h-10 rounded-full object-cover">

      <!-- Comment bubble + menu -->
      <div class="flex items-center gap-2">

        <!-- Bubble -->
        <div class="bg-gray-100 p-3 rounded-xl w-fit max-w-full relative break-words">
          <p class="font-semibold text-indigo-700">${c.username}</p>
          <p class="mt-1 text-gray-900">${c.content}</p>
          <p class="text-xs text-gray-500 mt-1">${formatTime(c.created_at)}</p>

        </div>

        <!-- Menu 3 ch·∫•m n·∫±m ngo√†i, cƒÉn gi·ªØa -->
        ${c.user_id === currentUserId
          ? `
    <!-- Menu c·ªßa ch·ªß comment -->
    <div class="relative flex items-center">
      <button onclick="toggleCommentMenu(${c.id})"
              class="text-gray-500 hover:text-gray-800 p-1 rounded-full hover:bg-gray-200 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
          </svg>
      </button>

      <div id="comment-menu-${c.id}"
           class="hidden absolute right-0 top-6 w-32 bg-white rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 z-[9999]">
        <button onclick="openeditComment(${c.id}, '${c.content.replace(/'/g, "\\'")}')"
                class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100">
          Ch·ªânh s·ª≠a
        </button>
        <button onclick="deleteComment(${c.id})"
                class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100">
          X√≥a
        </button>
      </div>
    </div>
  `
          : `
    <!-- Menu c·ªßa ng∆∞·ªùi kh√°c -->
    <div class="relative flex items-center">
      <button onclick="toggleCommentMenu(${c.id})"
              class="text-gray-500 hover:text-gray-800 p-1 rounded-full hover:bg-gray-200 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
          </svg>
      </button>

      <div id="comment-menu-${c.id}"
           class="hidden absolute right-0 top-6 w-32 bg-white rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 z-[9999]">
        <button onclick="hideComment(${c.id})"
                class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100">
          ·∫®n b√¨nh lu·∫≠n
        </button>
      </div>
    </div>
  `
        }


      </div>
    </div>

    <!-- Like + Reply -->
    <div class="flex gap-4 text-sm mt-1 ml-14">
      <button onclick="likeComment(${c.id})" class="text-gray-600 hover:text-blue-600">
        üëç Th√≠ch (${c.likes})
      </button>
      <button onclick="toggleReplyBox(${c.id}, '${c.username}')"
              class="text-gray-600 hover:text-blue-600">
        üí¨ Tr·∫£ l·ªùi
      </button>
    </div>

    <!-- Reply box -->
    <div id="replyBox-${c.id}" class="hidden ml-14 mt-2">
      <textarea id="replyInput-${c.id}"
                class="w-full border rounded-lg p-2 text-sm"
                placeholder="Vi·∫øt ph·∫£n h·ªìi..."></textarea>

      <button onclick="sendReply(${c.id})"
              class="mt-2 px-3 py-1 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">
        G·ª≠i
      </button>
    </div>

    ${c.replies.map(r => renderComment(r, level + 1)).join("")}

  </div>`;
    }


    function toggleCommentMenu(id) {
      const menu = document.getElementById(`comment-menu-${id}`);
      menu.classList.toggle("hidden");
    }

    function hideComment(id) {
      const el = document.getElementById(`comment-${id}`);
      if (!el) return;

      el.style.transition = "opacity .3s";
      el.style.opacity = 0;

      setTimeout(() => el.remove(), 300);
    }

    function formatTime(timeString) {
      const date = new Date(timeString);
      return date.toLocaleString("vi-VN", {
        hour: "2-digit",
        minute: "2-digit",
        day: "2-digit",
        month: "2-digit",
        year: "numeric"
      });
    }


    async function loadComments() {
      const id = getStoryId();
      const res = await fetch(`/api/comments?story_id=${id}`);
      const data = await res.json();

      currentUserId = data.currentUserId;

      document.getElementById("commentList").innerHTML =
        data.comments.map(c => renderComment(c)).join("");
    }
    loadComments();

    // S·ª≠a comments
    async function updateComment(commentId, newContent) {
      try {
        const res = await fetch("/api/comments", {
          method: "PUT",
          headers: {
            "Content-Type": "application/json"
          },
          credentials: "include", // g·ª≠i cookie JWT
          body: JSON.stringify({
            comment_id: commentId,
            content: newContent
          })
        });

        const data = await res.json();

        if (!res.ok) {
          alert(data.message || "L·ªói c·∫≠p nh·∫≠t comment");
          return;
        }

        alert("C·∫≠p nh·∫≠t comment th√†nh c√¥ng!");
        return true;

      } catch (err) {
        console.error("FE Update Comment Error:", err);
        alert("L·ªói k·∫øt n·ªëi server");
      }
    }

    // X√≥a comment
    async function deleteComment(commentId) {
      if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a comment n√†y?")) return;

      try {
        const res = await fetch("/api/comments", {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json"
          },
          credentials: "include",
          body: JSON.stringify({
            comment_id: commentId
          })
        });

        const data = await res.json();

        if (!res.ok) {
          showAlert("error", data.message || "L·ªói x√≥a comment", "L·ªói");
          return;
        }

        showAlert("success", "X√≥a comment th√†nh c√¥ng!", "Th√†nh c√¥ng");
        loadComments();
        return true;

      } catch (err) {
        console.error("FE Delete Comment Error:", err);
        alert("L·ªói k·∫øt n·ªëi server");
      }
    }

    // ======================= LIKE COMMENT =============================
    async function likeComment(commentId) {
      try {
        const res = await fetch("/api/comments/like", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          credentials: "include",   // B·∫ÆT BU·ªòC: g·ª≠i cookie authToken
          body: JSON.stringify({ comment_id: commentId })
        });

        const data = await res.json();

        if (res.ok) {
          loadComments();           // Reload comment sau khi like th√†nh c√¥ng
        } else {
          alert(data.message);      // Hi·ªÉn th·ªã l·ªói t·ª´ backend
        }
      } catch (err) {
        console.error("L·ªói k·∫øt n·ªëi:", err);
        alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi server.");
      }
    }



    // ======================= SHOW / HIDE REPLY BOX ====================
    function toggleReplyBox(commentId, parentUsername = "") {
      const box = document.getElementById(`replyBox-${commentId}`);
      box.classList.toggle("hidden");

      const textarea = document.getElementById(`replyInput-${commentId}`);
      if (!textarea.value && parentUsername) {
        textarea.value = `@${parentUsername} `; // Hi·ªÉn th·ªã s·∫µn t√™n ng∆∞·ªùi comment cha
      }
    }



    // ======================= SEND REPLY ===============================
    async function sendReply(commentId) {
      const input = document.getElementById(`replyInput-${commentId}`);
      const content = input.value.trim();

      if (!content) return alert("Vui l√≤ng nh·∫≠p n·ªôi dung!");

      const res = await fetch("/api/comments/reply", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          parent_id: commentId,
          content
        })
      });

      if (res.ok) {
        input.value = "";
        loadComments();
      }
    }

  </script>
</body>

</html>