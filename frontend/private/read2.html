<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ƒê·ªçc truy·ªán | DH.story</title>
  <link rel="icon" type="image/png" href="/components/Logo.png" />
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.8s ease-in forwards; }

    .cover {
      transition: transform 0.4s ease, box-shadow 0.4s ease;
    }
    .cover:hover {
      transform: scale(1.03);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .title-hover:hover {
      color: #4f46e5;
      text-shadow: 0 0 10px rgba(79, 70, 229, 0.2);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex flex-col font-sans">
  <!-- Header -->
  <header class="bg-white shadow-md">
    <div class="container mx-auto flex flex-col md:flex-row items-center justify-between py-4 px-6">
      
      <!-- Logo -->
      <div class="flex items-center gap-2">
        <a href="index2.html" class="flex items-center gap-2">
        <img src="/components/Logo.png" alt="Logo" class="w-10 h-10 rounded-full">
        <span class="text-2xl font-bold text-indigo-600">DH.story</span>
        </a>
      </div>

      <!-- Slogan -->
       <p class="italic text-gray-500 text-sm md:text-base mt-2 md:mt-0">
        Ch√∫c c√°c b·∫°n ƒë·ªçc truy·ªán vui v·∫ª!
      </p>
      <!-- Search -->
          <div class="relative">
          <div class="flex items-center bg-gray-100 rounded-full overflow-hidden shadow-inner">
          <input id="searchBox" type="text" placeholder="T√¨m ki·∫øm truy·ªán..."
                  class="px-4 py-2 bg-transparent focus:outline-none w-48 md:w-64 text-gray-700">
          <button id="searchBtn" class="px-3 text-indigo-600 hover:text-indigo-800" aria-label="T√¨m ki·∫øm">
            <i class="fa-solid fa-magnifying-glass"></i>
          </button>
          </div>

          <!-- Popover k·∫øt qu·∫£ -->
          <div id="searchSuggestions" 
              class="absolute left-0 right-0 bg-white shadow-lg rounded-lg mt-1 hidden max-h-64 overflow-y-auto z-50 border border-gray-200">
          </div>
          </div>


        <!-- Menu -->
        <nav>
          <ul class="flex flex-wrap justify-center md:justify-start gap-4 text-sm font-medium text-gray-700">
            <li><a href="Truy·ªán h√†i.html" class="hover:text-indigo-600">Truy·ªán h√†i</a></li>
            <li><a href="Truy·ªán ng√¥n t√¨nh.html" class="hover:text-indigo-600">Truy·ªán ng√¥n t√¨nh</a></li>
            <li><a href="Truy·ªán kinh d·ªã.html" class="hover:text-indigo-600">Truy·ªán kinh d·ªã</a></li>
            <li><a href="Truy·ªán trinh th√°m.html" class="hover:text-indigo-600">Truy·ªán trinh th√°m</a></li>
          </ul>
        </nav>

        <!-- Avatar -->
        <div class="relative">
          <button id="avatarButton" class="focus:outline-none">
            <img id="avatarImage" src="/components/Logo.png" alt="Avatar" 
                 class="w-10 h-10 rounded-full border-2 border-indigo-500 object-cover cursor-pointer hover:scale-110 transition-transform">
          </button>
          <div id="dropdownMenu" 
               class="hidden absolute right-0 mt-3 w-52 bg-white rounded-xl shadow-lg py-2 border border-gray-100 z-50">
            <hr class="my-1">
            <a href="/info.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50">
              <i class="fa-solid fa-user mr-2 text-indigo-500"></i>Th√¥ng tin c√° nh√¢n
            </a>
            <a href="/fav.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50">
              <i class="fa-solid fa-heart mr-2 text-pink-500"></i>Y√™u th√≠ch
            </a>
            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50">
              <i class="fa-solid fa-triangle-exclamation mr-2 text-yellow-500"></i>B√°o l·ªói
            </a>
            <div id="openLogoutModal" 
                class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 cursor-pointer">
                <i class="fa-solid fa-right-from-bracket mr-2"></i>ƒêƒÉng xu·∫•t
            </div>
          </div>
        </div>

      </div> 
    </div>
  </header>


  <div id="logoutModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-sm m-4 p-6 transform transition-all sm:my-8 sm:align-middle sm:max-w-lg">
        <div class="text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <i class="fa-solid fa-right-from-bracket text-red-600 text-xl"></i>
            </div>
            <h3 class="mt-4 text-lg leading-6 font-medium text-gray-900">X√°c nh·∫≠n ƒëƒÉng xu·∫•t</h3>
            <div class="mt-2">
                <p class="text-sm text-gray-500">
                    B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh·ªèi t√†i kho·∫£n c·ªßa m√¨nh kh√¥ng?
                </p>
            </div>
        </div>
        <div class="mt-5 sm:mt-6 flex justify-end gap-3">
            <button id="cancelLogout" type="button" 
                    class="inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:text-sm">
                H·ªßy
            </button>
            <button id="confirmLogout" type="button" 
                    class="inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:text-sm">
                ƒêƒÉng xu·∫•t
            </button>
        </div>
    </div>
</div>


    
    <!-- MAIN -->
      <main class="flex-1 container mx-auto py-10 px-6 fade-in">
    <div id="story-container" class="bg-white shadow-lg rounded-2xl p-8 flex flex-col md:flex-row gap-8">

      <!-- ·∫¢nh b√¨a -->
      <div class="flex-shrink-0 self-center">
        <img id="story-cover" src="" alt="B√¨a truy·ªán" class="w-56 h-80 object-cover rounded-xl cover" />
      </div>

      <!-- N·ªôi dung truy·ªán -->
      <div class="flex-1">
        <h1 id="story-title" class="text-3xl font-bold text-indigo-700 mb-2 title-hover"></h1>
        <p id="story-author" class="text-gray-600 mb-4 italic"></p>
        <p id="story-genres" class="text-sm text-gray-500 mb-6"></p>
        <a id="story-link" href="#" target="_blank"
           class="inline-block bg-indigo-600 text-white font-semibold px-5 py-2 rounded-xl shadow-md hover:bg-indigo-700 transition duration-300 mb-6">
           üìñ ƒê·ªçc truy·ªán g·ªëc
        </a>
        <button id="favButton"
        class="inline-flex items-center gap-2 bg-pink-500 text-white font-semibold px-5 py-2 rounded-xl shadow-md hover:bg-pink-600 transition duration-300">
  <i class="fa-solid fa-heart"></i> Y√™u th√≠ch
</button>
        <div id="story-content" class="leading-relaxed text-gray-800 text-justify whitespace-pre-line"></div>
      </div>
    </div>
  </main>

  <!--Modal danh s√°ch y√™u th√≠ch-->

  <div id="favModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">
    <h2 class="text-lg font-semibold text-indigo-700 mb-4">Th√™m truy·ªán v√†o danh s√°ch y√™u th√≠ch</h2>
    <div id="favListContainer" class="space-y-3 mb-4 text-gray-700 text-sm">
      <p class="text-gray-500 italic">ƒêang t·∫£i danh s√°ch...</p>
    </div>
    <div class="flex justify-between items-center gap-3">
      <input id="newListName" type="text" placeholder="T·∫°o danh s√°ch m·ªõi..." 
             class="flex-1 border rounded-lg px-3 py-2 text-sm focus:ring focus:ring-indigo-300 outline-none">
      <button id="createListBtn" 
              class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 text-sm">
        T·∫°o
      </button>
    </div>
    <div class="flex justify-end mt-4">
      <button id="closeFavModal" 
              class="text-gray-600 hover:text-gray-800 font-medium text-sm">ƒê√≥ng</button>
    </div>
  </div>
</div>

  <!-- Footer -->
  <footer class="bg-white mt-10 shadow-inner">
    <div class="container mx-auto py-6 px-6 flex flex-col md:flex-row justify-between items-center">
      <div class="flex items-center gap-2 mb-4 md:mb-0">
        <img src="/components/Logo.png" alt="Logo" class="w-8 h-8 rounded-full">
        <span class="font-bold text-indigo-600 text-lg">DH.story</span>
      </div>

      <div class="text-center md:text-right text-gray-600 text-sm">
        <p class="font-semibold text-gray-800 mb-1">LI√äN H·ªÜ V·ªöI T√îI</p>
        <a href="https://github.com/JahyuniJo" target="_blank" 
           class="flex items-center justify-center md:justify-end gap-2 hover:text-indigo-600">
          <span>Github</span>
          <img src="/components/Github.jpg" alt="Github" class="w-5 h-5 rounded-full">
        </a>
        <p>Email: <a href="mailto:dieu300504@gmail.com" class="hover:text-indigo-600">dieu300504@gmail.com</a></p>
        <p class="mt-2 text-xs text-gray-400">¬© 2025 DieuHoang</p>
      </div>
    </div>
  </footer>
  <script src="/components/alertModal.js"></script>
  <script>
    // --- FAVORITE LOGIC ---
const favBtn = document.getElementById("favButton");
const favModal = document.getElementById("favModal");
const favListContainer = document.getElementById("favListContainer");
const newListInput = document.getElementById("newListName");
const createListBtn = document.getElementById("createListBtn");
const closeFavModal = document.getElementById("closeFavModal");

// L·∫•y ID truy·ªán hi·ªán t·∫°i t·ª´ URL (?id=)
function getStoryId() {
  const params = new URLSearchParams(window.location.search);
  return params.get("id");
}

// M·ªü modal ch·ªçn danh s√°ch y√™u th√≠ch
favBtn.addEventListener("click", async () => {
  favModal.classList.remove("hidden");
  favListContainer.innerHTML = `<p class="text-gray-500 italic">ƒêang t·∫£i danh s√°ch...</p>`;

  try {

    const res = await fetch("/api/favlists", {
      headers: { "Content-Type": "application/json", },
      credentials: "include",
    });
    if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch");

    const lists = await res.json();

    if (lists.length === 0) {
      favListContainer.innerHTML = `<p class="text-gray-500 text-sm italic">B·∫°n ch∆∞a c√≥ danh s√°ch n√†o. H√£y t·∫°o m·ªõi ·ªü d∆∞·ªõi!</p>`;
    } else {
      favListContainer.innerHTML = lists.map(
        list => `
          <button onclick="addStoryToList(${list.id}, '${list.name.replace(/'/g, "\\'")}')"

                  class="block w-full text-left border border-gray-200 rounded-lg px-3 py-2 hover:bg-indigo-50 transition">
            <i class="fa-solid fa-heart text-pink-500 mr-2"></i>${list.name}
          </button>`
      ).join("");
    }
  } catch (err) {
    console.error(err);
    favListContainer.innerHTML = `<p class="text-red-500 text-sm">L·ªói t·∫£i danh s√°ch!</p>`;
  }
});

// ƒê√≥ng modal
closeFavModal.addEventListener("click", () => favModal.classList.add("hidden"));

// T·∫°o danh s√°ch m·ªõi
createListBtn.addEventListener("click", async () => {
  const name = newListInput.value.trim();
  if (!name) return showAlert("warning", "Vui l√≤ng nh·∫≠p t√™n danh s√°ch!", "C·∫£nh b√°o");

  try {
    const res = await fetch("/api/favlists", {
      method: "POST",
      headers: {
        "Content-Type": "application/json", 
      },
      credentials: "include",
      body: JSON.stringify({ name }),
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.message || "Kh√¥ng th·ªÉ t·∫°o danh s√°ch");

    newListInput.value = "";
    showAlert("success", `ƒê√£ t·∫°o danh s√°ch "${name}"!`, "Th√†nh c√¥ng");
    favBtn.click(); // reload l·∫°i modal
  } catch (err) {
    alert("‚ùå " + err.message);
  }
});

// Th√™m truy·ªán v√†o danh s√°ch
async function addStoryToList(listId, listName) {
  const storyId = getStoryId();
  if (!storyId) return showAlert("error", "ID truy·ªán kh√¥ng h·ª£p l·ªá!", "L·ªói");

  try {
    const res = await fetch(`/api/favlists/${listId}/stories`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      credentials: "include",
      body: JSON.stringify({ storyId }),
    });

    const data = await res.json();
    if (res.ok) {
      showAlert("success", `ƒê√£ th√™m truy·ªán v√†o danh s√°ch "${listName}"!`, "Th√†nh c√¥ng");
      favModal.classList.add("hidden");
    } else {
      showAlert("info", data.message || "Truy·ªán ƒë√£ c√≥ trong danh s√°ch!", "Th√¥ng b√°o");
    }
  } catch (err) {
    console.error("‚ùå L·ªói th√™m truy·ªán:", err);
    alert("L·ªói k·∫øt n·ªëi server!");
  }
}


    // --- Avatar dropdown menu ---
    const avatarBtn = document.getElementById('avatarButton');
    const dropdownMenu = document.getElementById('dropdownMenu');
    avatarBtn.addEventListener('click', () => dropdownMenu.classList.toggle('hidden'));
    window.addEventListener('click', (e) => {
      if (!avatarBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
        dropdownMenu.classList.add('hidden');
      }
    });

    async function loadUserAvatar() {
      try {
        const res = await fetch('/api/users/info');
        const data = await res.json();
        if (data.avatar_url) document.getElementById('avatarImage').src = data.avatar_url;
      } catch (err) {
        console.error('Kh√¥ng th·ªÉ t·∫£i avatar:', err);
      }
    }
    loadUserAvatar();


    // G·ªçi API l·∫•y chi ti·∫øt truy·ªán
    async function loadStory() {
      const id = getStoryId();
      if (!id) return;

      try {
        const res = await fetch(`/api/stories/${id}`);
        const story = await res.json();

        document.getElementById("story-cover").src = story.cover_url;
        document.getElementById("story-title").textContent = story.title;
        document.getElementById("story-author").textContent = "T√°c gi·∫£: " + story.author;
        document.getElementById("story-genres").textContent = "Th·ªÉ lo·∫°i: " + story.genres;
        document.getElementById("story-content").textContent = story.description;
        const link = document.getElementById("story-link");
        link.href = story.url;
        if (!story.url) link.classList.add("hidden");
      } catch (err) {
        console.error("L·ªói t·∫£i truy·ªán:", err);
      }
    }

    loadStory();



    // --- ƒêƒÉng xu·∫•t ---
    const logoutModal = document.getElementById('logoutModal');
    const openLogoutModal = document.getElementById('openLogoutModal');
    const cancelLogout = document.getElementById('cancelLogout');
    const confirmLogout = document.getElementById('confirmLogout');
    function showModal() {
        logoutModal.classList.remove('hidden');
    }

    // H√†m ·∫©n modal
    function hideModal() {
        logoutModal.classList.add('hidden');
    }

    // X·ª≠ l√Ω s·ª± ki·ªán m·ªü modal
    if (openLogoutModal) {
        openLogoutModal.addEventListener('click', showModal);
    }

    // X·ª≠ l√Ω s·ª± ki·ªán h·ªßy (ƒë√≥ng modal)
    if (cancelLogout) {
        cancelLogout.addEventListener('click', hideModal);
    }
    // ƒêƒÉng xu·∫•t
    if (confirmLogout) {
        confirmLogout.addEventListener('click', async () => {
            hideModal(); // ·∫®n modal ngay l·∫≠p t·ª©c

            try {
                const response = await fetch('/api/users/logout', {
                    method: 'GET',
                    credentials: 'include' // Quan tr·ªçng ƒë·ªÉ g·ª≠i HttpOnly Cookie
                });

                const data = await response.json();

                if (response.ok) {
                    // ƒêƒÉng xu·∫•t th√†nh c√¥ng, chuy·ªÉn h∆∞·ªõng
                    window.location.href = '/'; 
                } else {
                    // L·ªói server (v√≠ d·ª•: token ƒë√£ h·∫øt h·∫°n, server kh√¥ng ph·∫£n h·ªìi ƒë√∫ng)
                    alert(data.message || 'ƒêƒÉng xu·∫•t th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.');
                }
            } catch (error) {
                console.error('L·ªói k·∫øt n·ªëi khi ƒëƒÉng xu·∫•t:', error);
                alert('M·∫•t k·∫øt n·ªëi v·ªõi m√°y ch·ªß khi ƒëƒÉng xu·∫•t.');
                // ƒê·∫£m b·∫£o ng∆∞·ªùi d√πng bi·∫øt, nh∆∞ng kh√¥ng th·ªÉ l√†m g√¨ h∆°n ·ªü client
            }
        });
    }


     /* ==========================
   üîç SEARCH + POPOVER LOGIC
   ========================== */
const searchBox = document.getElementById("searchBox");
const searchBtn = document.getElementById("searchBtn");
const suggestionBox = document.getElementById("searchSuggestions");
let typingTimer;

// üß† H√†m debounce tr√°nh spam API
function debounce(func, delay) {
  clearTimeout(typingTimer);
  typingTimer = setTimeout(func, delay);
}

// üìå G·ªçi API g·ª£i √Ω Elasticsearch
async function fetchSuggestions(q) {
  if (!q.trim()) {
    suggestionBox.classList.add("hidden");
    return;
  }

  try {
    const res = await fetch(`/api/stories/search?q=${encodeURIComponent(q)}`);
    const data = await res.json();

    if (!data.length) {
      suggestionBox.innerHTML = `<p class="p-3 text-gray-500 text-sm">Kh√¥ng t√¨m th·∫•y...</p>`;
      suggestionBox.classList.remove("hidden");
      return;
    }

    // T·∫°o danh s√°ch g·ª£i √Ω
    suggestionBox.innerHTML = data.map(item => `
      <div onclick="openStory(${item.id})"
           class="flex items-center p-2 hover:bg-indigo-50 cursor-pointer">
        <img src="${item.cover_url || '/default-cover.jpg'}" class="w-10 h-14 object-cover rounded mr-3">
        <div>
          <p class="font-medium text-indigo-700">${item.title}</p>
          <p class="text-xs text-gray-500">${item.author || "Kh√¥ng r√µ t√°c gi·∫£"}</p>
        </div>
      </div>
    `).join("");

    suggestionBox.classList.remove("hidden");

  } catch (err) {
    console.error("‚ùå L·ªói fetchSuggest:", err);
  }
}
// üìå M·ªü truy·ªán khi ch·ªçn g·ª£i √Ω
window.openStory = function (id) {
  window.location.href = `/read2.html?id=${id}`;
};

// üìå Ch·ªçn g·ª£i √Ω ‚Üí search ngay
window.selectSuggestion = function (title) {
  searchBox.value = title;
  suggestionBox.classList.add("hidden");
  loadStories(1, title);
};

// ‚å® Khi ng∆∞·ªùi d√πng g√µ ‚Üí g·ªçi API g·ª£i √Ω
searchBox.addEventListener("input", () => {
  debounce(() => fetchSuggestions(searchBox.value), 200);
});

// ‚èé Enter ‚Üí t√¨m ki·∫øm
searchBox.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    suggestionBox.classList.add("hidden");
    loadStories(1, searchBox.value.trim());
  }
});

// üîç Click n√∫t t√¨m ki·∫øm
searchBtn.addEventListener("click", () => {
  suggestionBox.classList.add("hidden");
  loadStories(1, searchBox.value.trim());
});

// ·∫®n popover khi click ra ngo√†i
document.addEventListener("click", (e) => {
  if (!searchBox.contains(e.target) && !suggestionBox.contains(e.target)) {
    suggestionBox.classList.add("hidden");
  }
});
  </script>
</body>
</html>
