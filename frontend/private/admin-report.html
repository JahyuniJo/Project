<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý báo lỗi</title>
  <link rel="icon" type="image/png" href="/Logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-200 min-h-screen flex flex-col font-sans">

  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="ml-64">
      <div class="container mx-auto flex items-center justify-between py-4 px-6">
        <a class="flex items-center gap-2">
          <img src="/components/Logo.png" alt="Logo" class="w-10 h-10 rounded-full">
          <span class="text-2xl font-bold text-indigo-600">DH.story Admin</span>
        </a>
        <div class="flex items-center gap-4">
          <span class="text-gray-600 font-medium">Xin chào, Admin</span>
          <button onclick="logout()" class="px-3 py-2 bg-red-100 hover:bg-red-200 rounded-lg text-red-600 font-semibold transition">
            <i class="fa-solid fa-right-from-bracket mr-1"></i> Đăng xuất
          </button>
        </div>
      </div>
    </div>
  </header>

  <aside class="fixed left-0 top-0 h-full w-64 bg-white shadow-lg z-50 flex flex-col">
    <div class="h-16 flex items-center justify-center border-b">
      <span class="font-bold text-indigo-600 text-lg">Bảng điều khiển</span>
    </div>
    <nav class="flex-1 overflow-y-auto p-4 text-gray-700 font-medium">
      <a href="/user.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-indigo-50 hover:text-indigo-600"><i class="fa-solid fa-users"></i> Quản lý người dùng</a>
      <a href="/stat.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-indigo-50 hover:text-indigo-600"><i class="fa-solid fa-chart-column"></i> Thống kê</a>
      <a href="/stories.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-indigo-50 hover:text-indigo-600"><i class="fa-solid fa-book"></i> Quản lý truyện</a>
      <a href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-indigo-50 hover:text-indigo-600"><i class="fa-solid fa-robot"></i> Quản lý tác vụ AI</a>
      <a href="/admin-report.html" class="flex items-center gap-3 px-3 py-2 rounded-lg bg-indigo-100 text-indigo-700 font-semibold"><i class="fa-solid fa-triangle-exclamation"></i> Quản lý báo lỗi</a>
    </nav>
  </aside>

  <main class="flex-1 ml-64 px-8 py-8">
    <h2 class="text-3xl font-bold text-indigo-700 mb-8 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation"></i> Danh sách báo lỗi</h2>

    <div class="overflow-x-auto bg-white shadow-md rounded-xl">
      <table class="w-full text-left">
        <thead class="bg-gray-200 text-gray-700 font-semibold">
          <tr>
            <th class="p-4">Truyện</th>
            <th class="p-4">URL</th>
            <th class="p-4">Mô tả</th>
            <th class="p-4">Ảnh</th>
            <th class="p-4">Trạng thái</th>
            <th class="p-4">Hành động</th>
          </tr>
        </thead>
        <tbody id="reportTable" class="text-gray-700"></tbody>
      </table>
    </div>
  </main>

  <footer class="bg-white mt-auto shadow-inner ml-64">
    <div class="max-w-7xl mx-auto px-4 py-4 text-sm text-gray-500 text-center">© 2025 DH.story — Admin Panel</div>
  </footer>
  <!-- LIGHTBOX OVERLAY -->
<div id="imageModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden z-[9999] flex items-center justify-center">
  <div class="relative">
    <button onclick="closeImage()" class="absolute -top-4 -right-4 bg-white text-gray-700 hover:bg-gray-200 shadow-lg w-10 h-10 rounded-full flex items-center justify-center text-xl font-bold">&times;</button>
    <img id="modalImage" src="" class="max-w-[90vw] max-h-[90vh] rounded-xl shadow-2xl border-4 border-white">
  </div>
</div>


  <script>
async function loadReports() {
  const res = await fetch('/api/admin/reports');
  const reports = await res.json();
  const table = document.getElementById('reportTable');

  // render bảng
 // render bảng
  table.innerHTML = reports.map(r => `
    <tr class="border-b hover:bg-gray-50">
      <td class="p-4 font-semibold">${r.title || '-'}</td>
      <td class="p-4"><a href="${r.story_url}" class="text-indigo-600 hover:underline" target="_blank">Xem</a></td>
      <td class="p-4">${r.message}</td>
      <td class="p-4">${r.screenshot_path 
          ? `<img src="/uploads/${r.screenshot_path}" class="h-16 rounded shadow cursor-pointer hover:opacity-90 transition" onclick="openImage('/uploads/${r.screenshot_path}')">` 
          : '—'}</td>
      <td class="p-4">
        <select id="status-${r.id}" class="block w-full px-3 py-1 border border-gray-300 rounded-md bg-white text-sm font-medium text-gray-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
          <option value="pending" ${r.status==='pending' ? 'selected' : ''}>Pending</option>
          <option value="fixing" ${r.status==='fixing' ? 'selected' : ''}>Fixing</option>
          <option value="done" ${r.status==='done' ? 'selected' : ''}>Done</option>
          <option value="ignored" ${r.status==='ignored' ? 'selected' : ''}>Ignored</option>
        </select>
      </td>
      <td class="p-4 flex flex-col gap-2">
        <input type="text" id="response-${r.id}" placeholder="Nhập phản hồi..." 
               value="${r.response || ''}" class="px-2 py-1 border rounded text-sm">
        <button data-id="${r.id}" class="btn-send px-2 py-1 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition">Gửi phản hồi</button>
      </td>
    </tr>
  `).join('');

  // Gắn sự kiện cho nút gửi phản hồi
  document.querySelectorAll('.btn-send').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      const responseText = document.getElementById(`response-${id}`).value.trim();
      const status = document.getElementById(`status-${id}`).value;

      if (!responseText) return alert("Vui lòng nhập phản hồi!");

      await fetch(`/api/admin/reports/${id}/respond`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status, response: responseText })
      });

      loadReports();
    });
  });
}

// logout
function logout() {
  fetch('/api/users/logout').then(() => (window.location.href = '/'));
}

// load báo lỗi khi vào trang
loadReports();

// Hàm mở ảnh trong lightbox
function openImage(src) {
  document.getElementById('modalImage').src = src;
  document.getElementById('imageModal').classList.remove('hidden');
}

function closeImage() {
  document.getElementById('imageModal').classList.add('hidden');
}

// Đóng ảnh nếu click ra ngoài
document.getElementById('imageModal').addEventListener('click', (e) => {
  if (e.target.id === 'imageModal') closeImage();
});
</script>


</body>
</html>
