<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quản lý Truyện - DH.story</title>
  <link rel="icon" type="image/png" href="/Logo.png">
  <!-- Fontawesome (optional) + Tailwind -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white shadow sticky top-0 z-40">
    <div class="ml-64"> <!-- chừa khoảng cho sidebar -->
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-4">
            <img src="/components/Logo.png" alt="logo" class="w-10 h-10 rounded-full">
            <div>
              <h1 class="text-lg font-bold text-indigo-600">DH.story — Quản lý Truyện</h1>
              <p class="text-xs text-gray-500">Trang admin</p>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <button id="syncBtn" title="Đồng bộ từ Comi"
              class="px-3 py-2 bg-yellow-100 text-yellow-800 rounded hover:bg-yellow-200 text-sm">
              <i class="fa-solid fa-spider mr-2"></i>Đồng bộ
            </button>

            <button onclick="window.location.href='admin.html'"
              class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg shadow">
              ← Quay lại
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Sidebar -->
  <aside class="fixed left-0 top-0 h-full w-64 bg-white shadow-lg z-50 flex flex-col">
    <div class="h-16 flex items-center justify-center border-b">
      <span class="font-bold text-indigo-600 text-lg">Bảng điều khiển</span>
    </div>
    <nav class="flex-1 overflow-y-auto p-4 text-gray-700 font-medium">
      <a href="/user.html"
        class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-indigo-50 hover:text-indigo-600">
        <i class="fa-solid fa-users"></i> Quản lý người dùng
      </a>
      <a href="#"
        class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-indigo-50 hover:text-indigo-600">
        <i class="fa-solid fa-chart-column"></i> Thống kê
      </a>
      <a href="/stories.html"
        class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-indigo-50 hover:text-indigo-600">
        <i class="fa-solid fa-book"></i> Quản lý truyện
      </a>
      <a href="#"
        class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-indigo-50 hover:text-indigo-600">
        <i class="fa-solid fa-robot"></i> Quản lý tác vụ AI
      </a>
      <a href="#"
        class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-indigo-50 hover:text-indigo-600">
        <i class="fa-solid fa-triangle-exclamation"></i> Quản lý báo lỗi
      </a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="flex-1 ml-64">
    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <!-- Controls -->
      <div class="bg-white p-4 rounded-lg shadow mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div class="flex items-center gap-3 w-full md:w-2/3">
            <input id="searchInput" type="text" placeholder="Tìm theo tên truyện..."
              class="flex-1 border rounded px-3 py-2 focus:outline-none" />
            <button id="searchBtn" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Tìm</button>
            <button id="refreshBtn" class="bg-gray-200 px-3 py-2 rounded hover:bg-gray-300">Làm mới</button>
          </div>

          <div class="flex items-center gap-3 justify-end w-full md:w-auto">
            <label class="text-sm text-gray-600">Hiển thị:</label>
            <select id="limitSelect" class="border rounded px-2 py-1">
              <option value="8">8 / trang</option>
              <option value="12" selected>12 / trang</option>
              <option value="24">24 / trang</option>
              <option value="48">48 / trang</option>
            </select>
            <div class="text-xs text-gray-500">Tổng: <span id="totalCount">--</span></div>
          </div>
        </div>
      </div>

      <!-- Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
        <section class="lg:col-span-3">
          <div id="story-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-3 gap-4"></div>
        </section>

        <aside class="hidden lg:block">
          <div class="bg-white p-4 rounded-lg shadow h-full overflow-auto">
            <h3 class="font-semibold mb-3">Danh sách nhanh</h3>
            <div class="text-xs text-gray-500 mb-2">Click "Sửa" để edit / "Xóa" để remove</div>
            <div id="quickList" class="space-y-2"></div>
          </div>
        </aside>
      </div>

      <!-- Pagination -->
      <div class="mt-6 flex justify-center">
        <nav id="pagination" class="flex flex-wrap gap-2 items-center"></nav>
      </div>
    </section>
  </main>

  <!-- Edit Modal -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg w-full max-w-xl p-5 shadow-lg">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">Chỉnh sửa truyện</h3>
        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="editForm" class="space-y-3">
        <input type="hidden" id="editId">
        <div>
          <label class="text-sm text-gray-600">Tên truyện</label>
          <input id="editTitle" class="w-full border rounded px-3 py-2" required>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-gray-600">Tác giả</label>
            <input id="editAuthor" class="w-full border rounded px-3 py-2">
          </div>
          <div>
            <label class="text-sm text-gray-600">Trạng thái</label>
            <select id="editStatus" class="w-full border rounded px-2 py-2">
              <option>Đang ra</option>
              <option>Hoàn thành</option>
              <option>Tạm Ngưng</option>
            </select>
          </div>
        </div>
        <div>
          <label class="text-sm text-gray-600">Link ảnh bìa</label>
          <input id="editCover" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="text-sm text-gray-600">Link nguồn (url)</label>
          <input id="editSource" class="w-full border rounded px-3 py-2">
        </div>

        <div class="flex justify-end gap-2 mt-4">
          <button type="button" onclick="closeModal()" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300">Hủy</button>
          <button type="submit" class="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">Lưu</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-white mt-auto shadow-inner ml-64">
    <div class="max-w-7xl mx-auto px-4 py-4 text-sm text-gray-500 text-center">
      © 2025 DH.story — Admin Panel
    </div>
  </footer>



  <!-- Script -->
  <script>
    // Gọi api
    let limit = parseInt(document.getElementById('limitSelect').value, 10);
    const API = '/api/stories';
    let currentPage = 1;
    // Tối giản lệnh doucument.getElementById
    function qs(id) { return document.getElementById(id); }

    // Tải dữ liệu và xử lý API
    async function loadStories(page) {
      currentPage = page;
  const search = qs('searchInput').value.trim(); // Lấy giá trị từ ô tìm kiếm và xóa khoảng trắng thừa
  const limit = parseInt(qs('limitSelect').value, 10) || 12;
  const url = `${API}?page=${page}&limit=${limit}` + (search ? `&search=${encodeURIComponent(search)}` : ''); // Url API hoàn chỉnh
      // Thực hiện xử lý luồng khi call API
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error('Lỗi khi gọi API');
    const data = await res.json();

    // Hỗ trợ nhiều kiểu dữ liệu trả về khác nhau
    const stories = data.data || data.stories || data.rows || [];
    const totalItems = data.total || data.totalCount || data.totalItems || stories.length;
    const totalPages = data.totalPages || Math.max(1, Math.ceil(totalItems / limit));
    const currentPage = data.page || data.currentPage || page;

    renderCards(stories);
    renderQuickList(stories);
    renderPagination(totalPages, currentPage);

    qs('totalCount').textContent = totalItems || '--';
  } catch (err) {
    console.error('❌ Lỗi loadStories:', err);
    renderCards([]);
    renderQuickList([]);
    renderPagination(1, 1);
  }
}

    // Hiển thị danh sách truyện
    function renderCards(stories) {
      const container = qs('story-container');
      container.innerHTML = '';
      if (!stories || stories.length === 0) {
        container.innerHTML = '<div class="col-span-full bg-white p-6 rounded shadow text-center text-gray-500">Không tìm thấy truyện nào.</div>';
        return;
      }

      stories.forEach(s => {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-lg overflow-hidden shadow hover:shadow-lg transition group';
        card.innerHTML = `
          <div class="w-full h-44 bg-gray-100 overflow-hidden">
            <img src="${s.cover_url || '/components/Logo.png'}" alt="${escapeHtml(s.title)}" class="w-full h-full object-cover transform group-hover:scale-105 transition">
          </div>
          <div class="p-3">
            <h3 class="text-sm font-semibold text-gray-800 truncate">${escapeHtml(s.title)}</h3>
            <p class="text-xs text-gray-500 truncate">${escapeHtml(s.author || '')}</p>
            <div class="mt-3 flex items-center justify-between">
              <div class="text-xs text-gray-600">${escapeHtml(s.status || 'Đang cập nhật')}</div>
              <div class="flex items-center gap-2">
                <button class="text-blue-600 text-xs hover:underline" onclick="openEdit(${s.id})">Sửa</button>
                <button class="text-red-600 text-xs hover:underline" onclick="confirmDelete(${s.id}, '${escapeJs(s.title)}')">Xóa</button>
                <button class="text-gray-600 text-xs hover:underline" onclick="openSource('${escapeJs(s.url)}')">Mở</button>
              </div>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // Vẽ 1 danh sách nhanh 
    function renderQuickList(stories) {
      const wrap = qs('quickList');
      wrap.innerHTML = '';
      if (!stories || stories.length === 0) {
        wrap.innerHTML = '<div class="text-gray-400">Không có mục nào</div>';
        return;
      }
      stories.forEach(s => {
        const el = document.createElement('div');
        el.className = 'flex items-center justify-between gap-2 p-2 border rounded';
        el.innerHTML = `
          <div class="flex items-center gap-2">
            <img src="${s.cover_url || '/components/Logo.png'}" class="w-10 h-12 object-cover rounded">
            <div class="text-sm">${escapeHtml(s.title)}</div>
          </div>
          <div class="flex items-center gap-2">
            <button class="text-xs text-blue-600" onclick="openEdit(${s.id})">Sửa</button>
            <button class="text-xs text-red-600" onclick="confirmDelete(${s.id}, '${escapeJs(s.title)}')">Xóa</button>
          </div>
        `;
        wrap.appendChild(el);
      });
    }

    // Tạo các nút điều hướng và phân trang
    function renderPagination(total, current) {
      const nav = qs('pagination');
      nav.innerHTML = '';

      // Prev
      const prev = document.createElement('button');
      prev.className = `px-3 py-1 rounded ${current === 1 ? 'bg-gray-100 text-gray-400' : 'bg-gray-200 hover:bg-gray-300'}`;
      prev.textContent = '← Trang trước';
      prev.disabled = current === 1;
      prev.onclick = () => loadStories(current - 1);
      nav.appendChild(prev);

      // window of pages (show max 7 buttons)
      const maxButtons = 7;
      let start = Math.max(1, current - Math.floor(maxButtons / 2));
      let end = Math.min(total, start + maxButtons - 1);
      if (end - start < maxButtons - 1) start = Math.max(1, end - maxButtons + 1);

      if (start > 1) {
        const btn1 = pageButton(1, current);
        nav.appendChild(btn1);
        if (start > 2) {
          const dots = document.createElement('span'); dots.className = 'px-2 text-sm text-gray-500'; dots.textContent = '...';
          nav.appendChild(dots);
        }
      }

      for (let i = start; i <= end; i++) nav.appendChild(pageButton(i, current));

      if (end < total) {
        if (end < total - 1) {
          const dots = document.createElement('span'); dots.className = 'px-2 text-sm text-gray-500'; dots.textContent = '...';
          nav.appendChild(dots);
        }
        nav.appendChild(pageButton(total, current));
      }

      // Next
      const next = document.createElement('button');
      next.className = `px-3 py-1 rounded ${current === total ? 'bg-gray-100 text-gray-400' : 'bg-gray-200 hover:bg-gray-300'}`;
      next.textContent = 'Trang sau →';
      next.disabled = current === total;
      next.onclick = () => loadStories(current + 1);
      nav.appendChild(next);
    }

    function pageButton(i, current) {
      const btn = document.createElement('button');
      btn.textContent = i;
      btn.className = `px-3 py-1 rounded ${i === current ? 'bg-indigo-600 text-white' : 'bg-gray-200 hover:bg-gray-300'}`;
      btn.onclick = () => loadStories(i);
      return btn;
    }

    // Chỉnh sửa truyện
    function openEdit(id) {
      // Fetch single story if needed, for simplicity try to find on current page
      fetch(`${API}/${id}`)
        .then(r => { 
          if (!r.ok){
            throw new Error(`HTTP error! Status: ${r.status}`);
          }
         return r.json()
        })
        .then(s => {
          qs('editId').value = s.id;
          qs('editTitle').value = s.title || '';
          qs('editAuthor').value = s.author || '';
          qs('editStatus').value = s.status || 'ongoing';
          qs('editCover').value = s.cover_url || '';
          qs('editSource').value = s.url || '';
          qs('editModal').classList.remove('hidden');
          qs('editModal').classList.add('flex');

        })
        .catch(err => {
          // fallback: open modal empty then try to fill
          console.error(err);
        });
    }

    function closeModal() {
      qs('editModal').classList.add('hidden');
      qs('editModal').classList.remove('flex');
      qs('editForm').reset();
    }

    // Xử lí sự kiện ấn nút submit và hiển thị toast nếu thành công
    qs('editForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const id = qs('editId').value;
      const payload = {
        title: qs('editTitle').value.trim(),
        author: qs('editAuthor').value.trim(),
        status: qs('editStatus').value,
        cover_url: qs('editCover').value.trim(),
        url: qs('editSource').value.trim()
      };
      try {
        const res = await fetch(`${API}/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('Update failed');
        closeModal();
        showToast('✅ Đã cập nhật truyện thành công!');
        await loadStories(currentPage);
      } catch (err) {
         console.error('Lỗi khi lưu thay đổi:', err);
        showToast('❌ Lỗi khi lưu thay đổi!', 'error');
      }
    });

    // Xóa truyện
    function confirmDelete(id, title) {
      if (!confirm(`Xác nhận xóa truyện: "${title}" ?`)) return;
      deleteStory(id);
    }
    async function deleteStory(id) {
      try {
        const res = await fetch(`${API}/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Delete failed');
        showToast('✅ Đã xóa truyện thành công!');
        await loadStories(currentPage);
      } catch (err) {
        console.error('Lỗi khi xóa truyện:', err);
        showToast('❌ Lỗi khi xóa truyện', 'error');
      }
    }

    // Mở link nguồn
    function openSource(url) {
      if (!url) return alert('Không có link nguồn');
      window.open(url, '_blank');
    }

    // Hàm đồng bộ dữ liệu từ trang crawl
    qs('syncBtn').addEventListener('click', async () => {
      if (!confirm('Đồng bộ từ comi sẽ thêm các truyện mới vào DB. Tiếp tục?')) return;
      qs('syncBtn').disabled = true;
      qs('syncBtn').textContent = 'Đang đồng bộ...';
      try {
        const res = await fetch(`${API}/sync`, { method: 'POST' });
        const data = await res.json();
        alert(data.message || 'Đã đồng bộ');
        await loadStories(1);
      } catch (err) {
        alert('Đồng bộ thất bại');
        console.error(err);
      } finally {
        qs('syncBtn').disabled = false;
        qs('syncBtn').textContent = 'Đồng bộ';
      }
    });

    
    // Fetch single story route must exist in backend, otherwise fallback
    // If not present, we can query list and find it.
    // Try to provide a safe fallback:
    async function fetchStoryFallback(id) {
      try {
        const res = await fetch(`${API}?page=${currentPage}&limit=${limit}`);
        const data = await res.json();
        const arr = data.stories || [];
        return arr.find(x => String(x.id) === String(id)) || {};
      } catch (e) { return {}; }
    }

    // If backend lacks GET /api/stories/:id, patch openEdit to use fallback
    // Override openEdit to use fallback when 404:
    const originalOpenEdit = openEdit;
    openEdit = async function (id) {
      try {
        const res = await fetch(`${API}/${id}`);
        if (!res.ok) throw new Error('no single route');
        const s = await res.json();
        qs('editId').value = s.id;
        qs('editTitle').value = s.title || '';
        qs('editAuthor').value = s.author || '';
        qs('editStatus').value = s.status || 'ongoing';
        qs('editCover').value = s.cover_url || '';
        qs('editSource').value = s.url || '';
      } catch (err) {
        const s = await fetchStoryFallback(id);
        qs('editId').value = s.id || id;
        qs('editTitle').value = s.title || '';
        qs('editAuthor').value = s.author || '';
        qs('editStatus').value = s.status || 'ongoing';
        qs('editCover').value = s.cover_url || '';
        qs('editSource').value = s.url || '';
      }
      qs('editModal').classList.remove('hidden');
      qs('editModal').classList.add('flex');
    };

    // Kick off initial load
    loadStories(1);


    // Hiển thị thông báo
  function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  toast.textContent = message;

  // Gán màu nền tùy theo loại thông báo
  const baseClasses =
    'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 ' +
    'px-6 py-4 rounded-2xl shadow-2xl font-semibold text-lg z-50 ' +
    'transition-all duration-500 ease-in-out scale-90 opacity-0';
  const bgClass =
    type === 'error'
      ? 'bg-red-500'
      : type === 'warning'
      ? 'bg-yellow-500 text-black'
      : 'bg-green-500';
  toast.className = `${baseClasses} ${bgClass}`;

  // Hiện toast với hiệu ứng phóng to + mờ dần vào
  requestAnimationFrame(() => {
    toast.classList.remove('hidden');
    toast.classList.add('scale-100', 'opacity-100');
  });

  // Tự ẩn sau 2 giây
  setTimeout(() => {
    toast.classList.remove('scale-100', 'opacity-100');
    toast.classList.add('scale-90', 'opacity-0');
    setTimeout(() => toast.classList.add('hidden'), 500);
  }, 1000);
}



// Hàm tìm kiếm
    let searchTimeout;
    qs('searchInput').addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => loadStories(1), 400); // đợi 400ms sau khi ngừng gõ
    });

    qs('searchBtn').addEventListener('click', () => loadStories(1));
    qs('refreshBtn').addEventListener('click', () => {
    qs('searchInput').value = '';
    loadStories(1);
    });
    qs('limitSelect').addEventListener('change', () => loadStories(1));

    // Utilities to avoid XSS in injected HTML
    function escapeHtml(s) {
      if (!s) return '';
      return String(s).replace(/[&<>"']/g, function (m) {
        return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m];
      });
    }
    function escapeJs(s) {
      if (!s) return '';
      return String(s).replace(/'/g, "\\'").replace(/"/g, '\\"');
    }



// Logic thanh tìm kiếm
(function () {
  const input = document.getElementById('searchInput'); // Khởi tạo input là văn bản nhập vào thanh tìm kiếm

  
  let pop = document.createElement('div'); // Tạo 1 popover (div) trong bộ nhớ để chưa danh sách trả về
  pop.className = 'hidden suggest-pop absolute bg-white border rounded-lg shadow-lg w-full z-50'; // Set Tailwind Css
  pop.setAttribute('role', 'listbox'); // Set giá trị
  pop.id = 'suggestPopover'; // Set id
  document.body.appendChild(pop); // Đưa phần tử popover vừa tạo vào cuối thẻ <body> của tài liệu
  
    // Hàm cấu tạo hiển thị popover ngay dưới thanh tìm kiếm (Responsive)
  function positionPopover() {
    const rect = input.getBoundingClientRect();
    pop.style.width = Math.max(rect.width, 300) + 'px';
    pop.style.left = rect.left + window.scrollX + 'px';
    pop.style.top = rect.bottom + window.scrollY + 'px';
  }

  // Hẹn giờ và delay call API tránh quá tải server
  let timer = null; 
  const DEBOUNCE = 300;

  // Lưu trữ danh sách kết quả gợi ý từ API
  let items = [];
  // theo dõi mục gợi ý đang được chọn bằng bàn phím (UX)
  let activeIndex = -1;

  // Hàm hiển thị suggest, nhận 1 list
  function render(list) {
    items = list || [];
    activeIndex = -1;
  // Nếu danh sách rỗng thì ẩn popover
    if (!items || items.length === 0) {
      pop.classList.add('hidden');
      pop.innerHTML = '';
      return;
    }

    // Tạo HTML chi tiết cho mỗi truyện
    pop.innerHTML = items.map((s, idx) => `
      <div
        class="cursor-pointer p-2 flex gap-3 items-center hover:bg-gray-100"
        role="option"
        data-idx="${idx}"
        data-id="${s.id}"
        data-title="${escapeHtml(s.title)}" 
      >
        <img src="${s.cover_url || '/components/Logo.png'}"
             onerror="this.src='/components/Logo.png'"
             class="w-12 h-14 object-cover rounded-sm flex-shrink-0">
        <div class="flex-1 min-w-0">
          <div class="text-sm font-medium text-gray-800 truncate">${highlight(s.title, input.value)}</div>
          <div class="text-xs text-gray-500 truncate">${escapeHtml(s.author || '')} ${s.status ? ' · ' + escapeHtml(s.status) : ''}</div>
        </div>
      </div>
    `).join('');

    positionPopover();
    pop.classList.remove('hidden');
  }

  // Làm nổi bật chữ tìm kiếm
  function highlight(text, q) {
    if (!q) return escapeHtml(text);
    const re = new RegExp(escapeRegExp(q), 'ig');
    return escapeHtml(text).replace(re, m => `<mark class="bg-yellow-200 text-yellow-900 px-0">${m}</mark>`);
  }

  // Biến các ký tự đặc biệt thành các thực thể HTML tương đương tránh tấn công XSS
  function escapeHtml(s) {
    if (!s) return '';
    return String(s).replace(/[&<>"']/g, function (m) {
      return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m];
    });
  }
  // Đảm bảo chuỗi nhập của người dùng là văn bản
  function escapeRegExp(s) {
    return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  // Gọi API đến /api/stories/search để lấy dữ liệu với từ khóa đã mã hóa encodeURIComponent, trả về dữ liệu JSON và render ra màn hình
  async function fetchSuggest(q) {
    if (!q || q.trim() === '') {
      render([]);
      return;
    }
    try {
      const res = await fetch(`${API}/search?q=${encodeURIComponent(q)}`);
      if (!res.ok) throw new Error('network');
      const data = await res.json();
      // expect array of {id,title,cover,author,status}
      render(Array.isArray(data) ? data : []);
    } catch (err) {
      console.error('Suggest error', err);
      render([]);
    }
  }

  // Lắng nghe dữ liệu nhập vào, xóa bộ hẹn giờ cũ và active Debounce
  input.addEventListener('input', (e) => {
    clearTimeout(timer);
    const q = e.target.value;
    timer = setTimeout(() => fetchSuggest(q), DEBOUNCE);
  });

 
  // Khi người dùng nhấn vào 1 mục trong popover nó sẽ lấy data-id và data-title để gọi hàm selectAndNavigate
  pop.addEventListener('click', (ev) => {
    const item = ev.target.closest('[data-id]');
    if (!item) return;
    const id = item.getAttribute('data-id');
    const title = item.getAttribute('data-title');
    selectAndNavigate(id, title);
  });

 
  // Cập nhật thanh tìm kiếm bằng mục đã được chọn và gọi lại loadStories để hiển thị truyện với mục ở thanh tìm kiếm
  function selectAndNavigate(id, title) {
  input.value = title || input.value;
  pop.classList.add('hidden');

  // Gọi loadStories để lọc theo tiêu đề (search input đang có)
  loadStories(currentPage);
}


 // Khi người dùng nhập ra khỏi thanh tìm kiếm thì ẩn popover
  document.addEventListener('click', (ev) => {
    if (ev.target === input || pop.contains(ev.target)) return;
    pop.classList.add('hidden');
  });

 // Người dùng nhấp vào thanh tìm kiếm nếu vẫn có dl thì sẽ hiển thị lại popover (UX)
  input.addEventListener('focus', () => {
    if (pop.innerHTML.trim()) {
      positionPopover();
      pop.classList.remove('hidden');
    }
  });



 // Xử lí người dùng xử dụng các nút lên xuống chọn dữ liệu và enter để xác nhận (UX)
  input.addEventListener('keydown', (ev) => {
    if (pop.classList.contains('hidden')) return;

    const count = items.length;
    if (ev.key === 'ArrowDown') {
      ev.preventDefault();
      activeIndex = Math.min(count - 1, activeIndex + 1);
      setActive(activeIndex);
    } else if (ev.key === 'ArrowUp') {
      ev.preventDefault();
      activeIndex = Math.max(0, activeIndex - 1);
      setActive(activeIndex);
    } else if (ev.key === 'Enter') {
      ev.preventDefault();
      if (activeIndex >= 0 && items[activeIndex]) {
        const it = items[activeIndex];
        selectAndNavigate(it.id, it.title);
      } else {
        currentPage = 1; 
        loadStories(currentPage);
        pop.classList.add('hidden');
      }
    } else if (ev.key === 'Escape') {
      pop.classList.add('hidden');
    }
  });





 // Thêm lớp CSS vào mục đang được chọn bằng bàn phím trong popover
  function setActive(idx) {
    Array.from(pop.children).forEach((c, i) => {
      c.classList.toggle('suggest-item-active', i === idx);
      if (i === idx) {
        // ensure visible
        const cRect = c.getBoundingClientRect();
        const pRect = pop.getBoundingClientRect();
        if (cRect.top < pRect.top) c.scrollIntoView({ block: 'nearest' });
        else if (cRect.bottom > pRect.bottom) c.scrollIntoView({ block: 'nearest' });
      }
    });
  }


  // Xử lí sự kiện người dùng thay đổi kích thước trình duyệt và lăn chuột thì popover vẫn hiển thị dễ nhìn (UI/UX)
  window.addEventListener('resize', positionPopover);
  window.addEventListener('scroll', positionPopover, true);

  // initial click outside handler to close (immediately)
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') pop.classList.add('hidden');
  });

  // ensure tab focus goes into items (keyboard accessible)
  pop.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      const el = document.activeElement.closest('[data-id]');
      if (el) {
        selectAndNavigate(el.getAttribute('data-id'), el.getAttribute('data-title'));
        pop.classList.add('hidden');
      }
    }
  });

})();
</script>


   <!-- Toast thông báo trung tâm -->
<div id="toast"
  class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2
         px-6 py-4 rounded-2xl shadow-2xl text-white font-semibold text-lg
         transition-all duration-500 ease-in-out scale-90 opacity-0 z-50">
  ✅ Cập nhật thành công!
</div>

<style>
  /* Một vài chỉnh thêm cho popover */
  .suggest-pop {
    max-height: 360px;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
  }
  .suggest-item-active {
    background-color: rgba(99,102,241,0.12); /* indigo-300/opacity */
  }
</style>
</body>
</html>
